<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reports - Lab Management System</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .page-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .filter-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
    }

    .result-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: box-shadow 0.2s;
      cursor: pointer;
    }

    .result-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .status-preliminary {
      background-color: #fff3cd;
      color: #856404;
    }

    .status-final {
      background-color: #28a745;
      color: white;
    }

    .result-positive {
      color: #dc3545;
      font-weight: bold;
    }

    .result-negative {
      color: #28a745;
    }

    /* Print Styles - Optimized for single page */
    @media print {
      @page {
        size: letter;
        margin: 0.3in 0.4in;
      }
      
      .no-print {
        display: none !important;
      }
      
      /* Hide navbar and header elements */
      #navbar-container {
        display: none !important;
      }
      
      nav, .navbar {
        display: none !important;
      }
      
      header {
        display: none !important;
      }
      
      .page-header {
        display: none !important;
      }
      
      body {
        background: white;
        font-size: 10px !important;
        padding-top: 0 !important;
        margin-top: 0 !important;
      }
      
      .container {
        width: 100% !important;
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
      }
      
      .report-container {
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
        box-shadow: none !important;
      }
      
      .report-header {
        page-break-after: avoid;
        border-bottom: 2px solid #2196F3 !important;
        padding-bottom: 0.3rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      .report-header h3 {
        font-size: 14px !important;
        margin-bottom: 2px !important;
      }
      
      .report-header p {
        font-size: 9px !important;
        margin-bottom: 1px !important;
        line-height: 1.2 !important;
      }
      
      .report-table {
        page-break-inside: avoid;
        margin: 0.3rem 0 !important;
      }
      
      .report-table th {
        padding: 2px 4px !important;
        font-size: 9px !important;
      }
      
      .report-table td {
        padding: 2px 4px !important;
        font-size: 8px !important;
      }
      
      h5 {
        font-size: 11px !important;
        padding: 4px !important;
        margin: 0.4rem 0 0.2rem 0 !important;
      }
      
      .interpretation-box {
        padding: 0.3rem !important;
        margin: 0.5rem 0 !important;
        font-size: 8px !important;
        line-height: 1.3 !important;
      }
      
      .interpretation-box h6 {
        font-size: 9px !important;
        margin-bottom: 0.2rem !important;
      }
      
      .interpretation-box p {
        font-size: 8px !important;
        margin-bottom: 0 !important;
      }
      
      .signature-line {
        width: 150px !important;
        margin-top: 1rem !important;
      }
      
      .lab-header {
        margin-bottom: 0.3rem !important;
      }
    }

    .report-container {
      background: white;
      padding: 2rem;
      margin: 2rem 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .report-header {
      border-bottom: 3px solid #2196F3;
      padding-bottom: 1rem;
      margin-bottom: 1.5rem;
    }

    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }

    .report-table th {
      background-color: #f5f5f5;
      padding: 0.5rem;
      text-align: left;
      border: 1px solid #ddd;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .report-table td {
      padding: 0.5rem;
      border: 1px solid #ddd;
      font-size: 0.875rem;
    }

    .lab-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }

    .interpretation-box {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      margin: 1.5rem 0;
      border-left: 4px solid #2196F3;
      font-size: 0.875rem;
    }

    .signature-line {
      border-top: 1px solid #000;
      width: 200px;
      margin-top: 3rem;
      display: inline-block;
    }
  </style>
</head>
<body>
  <!-- Navbar placeholder -->
  <div id="navbar-container"></div>

  <!-- Page Header -->
  <div class="page-header no-print">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h1><i class="fas fa-file-medical me-3"></i>PCR Test Reports</h1>
          <p class="mb-0">View and print test results</p>
        </div>
        <div class="col-md-6 text-md-end">
          <button class="btn btn-light" onclick="ReportsManager.loadResults()">
            <i class="fas fa-sync"></i> Refresh
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Filter Section -->
    <div class="filter-card no-print">
      <div class="row">
        <div class="col-md-3">
          <label class="form-label">Patient Name/ID</label>
          <input type="text" class="form-control" id="patientSearch" placeholder="Search...">
        </div>
        <div class="col-md-2">
          <label class="form-label">Status</label>
          <select class="form-select" id="statusFilter">
            <option value="">All</option>
            <option value="Final">Final Only</option>
            <option value="Preliminary">Preliminary</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Result</label>
          <select class="form-select" id="resultFilter">
            <option value="">All</option>
            <option value="Positive">Positive</option>
            <option value="Negative">Negative</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">From Date</label>
          <input type="date" class="form-control" id="fromDate">
        </div>
        <div class="col-md-2">
          <label class="form-label">To Date</label>
          <input type="date" class="form-control" id="toDate">
        </div>
        <div class="col-md-1 d-flex align-items-end">
          <button class="btn btn-primary w-100" onclick="ReportsManager.applyFilters()">
            <i class="fas fa-search"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Results List -->
    <div id="resultsList" class="no-print">
      <!-- Results will be loaded here -->
    </div>

    <!-- Report View (Hidden by default, shown when viewing a specific report) -->
    <div id="reportView" style="display: none;">
      <div class="no-print mb-3">
        <button class="btn btn-secondary" onclick="ReportsManager.backToList()">
          <i class="fas fa-arrow-left"></i> Back to List
        </button>
        <button class="btn btn-primary" onclick="window.print()">
          <i class="fas fa-print"></i> Print Report
        </button>
        <button class="btn btn-success" onclick="ReportsManager.downloadPDF()">
          <i class="fas fa-file-pdf"></i> Download PDF
        </button>
      </div>
      
      <div id="reportContent" class="report-container">
        <!-- Report will be generated here -->
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/navbar-loader.js"></script>

  <script>
    const ReportsManager = {
      results: [],
      currentResult: null,
      labSettings: null,

      init: function() {
        if (!AuthManager.isAuthenticated()) {
          window.location.href = '/login';
          return;
        }

        $.ajaxSetup({
          headers: AuthManager.getAuthHeaders()
        });

        this.loadLabSettings();
        this.loadResults();
      },

      loadLabSettings: async function() {
        try {
          const response = await $.get('/api/settings');
          this.labSettings = response.settings;
        } catch (error) {
          console.error('Error loading lab settings:', error);
        }
      },

      loadResults: async function() {
        try {
          // Load PCR results
          const response = await $.ajax({
            url: '/api/pcr/results',
            method: 'GET',
            data: { 
              status: 'Final',
              limit: 100 
            }
          });

          this.results = response.results || [];
          this.displayResults();
        } catch (error) {
          console.error('Error loading results:', error);
          $('#resultsList').html('<div class="alert alert-danger">Failed to load results. Please try again.</div>');
        }
      },

      displayResults: function() {
        const container = $('#resultsList');
        
        if (this.results.length === 0) {
          container.html('<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No finalized reports available.</div>');
          return;
        }

        let html = '';
        this.results.forEach(result => {
          const date = new Date(result.performedDate || result.createdAt);
          const patient = result.patient || {};
          const overallStatus = result.overallResult?.status || 'Unknown';
          const statusClass = overallStatus === 'Positive' ? 'result-positive' : 'result-negative';
          
          html += '<div class="result-card" onclick="ReportsManager.viewReport(\'' + result._id + '\')">';
          html += '<div class="row align-items-center">';
          html += '<div class="col-md-2">';
          html += '<strong>Result #:</strong> ' + (result.resultNumber || 'N/A') + '<br>';
          html += '<small>' + date.toLocaleDateString() + '</small>';
          html += '</div>';
          html += '<div class="col-md-3">';
          html += '<strong>Patient:</strong> ' + (patient.firstName || '') + ' ' + (patient.lastName || '') + '<br>';
          html += '<small>ID: ' + (patient.patientId || 'N/A') + '</small>';
          html += '</div>';
          html += '<div class="col-md-2">';
          html += '<strong>Test:</strong> ' + (result.test?.testName || result.panel || 'PCR') + '<br>';
          html += '<strong>Order:</strong> ' + (result.order?.orderNumber || 'N/A');
          html += '</div>';
          html += '<div class="col-md-2">';
          html += '<span class="' + statusClass + '">' + overallStatus.toUpperCase() + '</span>';
          html += '</div>';
          html += '<div class="col-md-2">';
          html += '<span class="status-badge status-' + result.status.toLowerCase() + '">' + result.status + '</span>';
          html += '</div>';
          html += '<div class="col-md-1 text-end">';
          html += '<button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); ReportsManager.viewReport(\'' + result._id + '\')">';
          html += '<i class="fas fa-eye"></i>';
          html += '</button>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
        });

        container.html(html);
      },

      viewReport: async function(resultId) {
        try {
          const response = await $.get('/api/pcr/results/' + resultId);
          this.currentResult = response.result;
          
          // If order is just an ID, try to fetch order details
          if (typeof response.result.order === 'string') {
            try {
              const orderResponse = await $.get('/api/orders/' + response.result.order);
              response.result.order = orderResponse.order;
            } catch (e) {
              console.log('Could not fetch order details');
            }
          }
          
          this.generateReport(response.result);
          
          $('#resultsList').hide();
          $('#reportView').show();
        } catch (error) {
          console.error('Error loading result details:', error);
          alert('Failed to load report details');
        }
      },

      generateReport: function(result) {
        const patient = result.patient || {};
        const settings = this.labSettings || {};
        const reportDate = new Date().toLocaleDateString();
        const collectionDate = result.sampleInfo?.collectionDate ? 
          new Date(result.sampleInfo.collectionDate).toLocaleString() : 'N/A';
        const receivedDate = result.sampleInfo?.receivedDate ? 
          new Date(result.sampleInfo.receivedDate).toLocaleString() : 'N/A';
        
        // Get the actual order number
        const orderNumber = result.order?.orderNumber || result.resultNumber || 'N/A';
        
        // Get patient sex/gender - handle all variations
        let displaySex = 'N/A';
        if (patient.gender) {
          displaySex = patient.gender.toLowerCase() === 'male' ? 'M' : 
                      patient.gender.toLowerCase() === 'female' ? 'F' : 
                      patient.gender.charAt(0).toUpperCase();
        } else if (patient.sex) {
          displaySex = patient.sex.toLowerCase() === 'male' ? 'M' : 
                      patient.sex.toLowerCase() === 'female' ? 'F' : 
                      patient.sex.charAt(0).toUpperCase();
        }
        
        // Extract phone number properly
        const labPhone = typeof settings.phone === 'object' ? 
          (settings.phone.primary || settings.phone.main || '818-877-4040') : 
          (settings.phone || '818-877-4040');
        
        const labFax = typeof settings.fax === 'object' ? 
          (settings.fax.primary || settings.fax.main || '818-403-3386') : 
          (settings.fax || '818-403-3386');
        
        // Build interpretation text
        const interpretationText = result.overallResult?.clinicalInterpretation || 
          '"Not Detected" results do not preclude urinary tract infection and should not be used as the sole basis for treatment or other patient decisions. "Detected" results are indicative of possible active urinary tract infection or coinfection with other bacteria. The pathogen(s) detected may not be the definitive cause of disease. Clinical correlation is recommended.';
        
        let reportHtml = '';
        reportHtml += '<div class="report-header">';
        reportHtml += '<div class="lab-header">';
        reportHtml += '<div>';
        reportHtml += '<h3 style="color: #2c5aa0; margin-bottom: 5px;">MATRIX LABORATORIES</h3>';
        reportHtml += '<p class="mb-1"><strong>DIRECTOR:</strong> ' + (settings.labDirector?.firstName || 'Mike M.') + ' ' + (settings.labDirector?.lastName || 'Moradian') + ', ' + (settings.labDirector?.credentials || 'PhD., Bioanalyst') + '</p>';
        reportHtml += '<p class="mb-1">' + (settings.address?.street || '6618 San Fernando Rd') + ', ' + (settings.address?.city || 'Glendale') + ', ' + (settings.address?.state || 'CA') + ' ' + (settings.address?.zipCode || '91201') + '</p>';
        reportHtml += '<p class="mb-0"><strong>Phone:</strong> ' + labPhone + ' <strong>Fax:</strong> ' + labFax + '</p>';
        reportHtml += '<p class="mb-0"><strong>Email:</strong> ' + (settings.email || 'info@matrixlabs.co') + '</p>';
        reportHtml += '</div>';
        reportHtml += '<div class="text-end">';
        reportHtml += '<span style="background-color: #28a745; color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold;">FINAL</span><br>';
        reportHtml += '<small class="text-muted mt-2">Page 1 of 1</small>';
        reportHtml += '</div>';
        reportHtml += '</div>';
        reportHtml += '</div>';

        reportHtml += '<table class="report-table mt-3">';
        reportHtml += '<tr style="background-color: #f8f9fa;">';
        reportHtml += '<td><strong>Patient:</strong> ' + (patient.firstName || '') + ' ' + (patient.lastName || '') + '</td>';
        reportHtml += '<td><strong>Accn#:</strong> ' + orderNumber + '</td>';
        reportHtml += '<td><strong>Drawn:</strong> ' + collectionDate + '</td>';
        reportHtml += '</tr>';
        reportHtml += '<tr>';
        reportHtml += '<td><strong>P.ID #:</strong> ' + (patient.patientId || 'N/A') + '</td>';
        reportHtml += '<td><strong>Dr:</strong> ' + (result.order?.orderingPhysician?.name || 'N/A') + '</td>';
        reportHtml += '<td><strong>Recvd:</strong> ' + receivedDate + '</td>';
        reportHtml += '</tr>';
        reportHtml += '<tr style="background-color: #f8f9fa;">';
        reportHtml += '<td><strong>DoB:</strong> ' + (patient.dateOfBirth ? new Date(patient.dateOfBirth).toLocaleDateString() : 'N/A') + ' <strong>Age:</strong> ' + this.calculateAge(patient.dateOfBirth) + ' <strong>Sex:</strong> ' + displaySex + '</td>';
        reportHtml += '<td><strong>Location:</strong> ' + (settings.address?.street || 'N/A') + '</td>';
        reportHtml += '<td><strong>Print:</strong> ' + reportDate + '</td>';
        reportHtml += '</tr>';
        reportHtml += '</table>';

        reportHtml += '<h5 class="mt-4" style="background-color: #e7f3ff; padding: 8px; border-left: 4px solid #2196F3;">';
        reportHtml += 'MOLECULAR ' + (result.panel || result.test?.panel || 'UTI') + ' PANEL (PCR)';
        reportHtml += '</h5>';
        
        reportHtml += '<table class="report-table">';
        reportHtml += '<thead style="background-color: #e9ecef;">';
        reportHtml += '<tr>';
        reportHtml += '<th style="padding: 8px; font-weight: bold;">Test</th>';
        reportHtml += '<th style="padding: 8px; font-weight: bold;">Result</th>';
        reportHtml += '<th style="padding: 8px; font-weight: bold;">Units</th>';
        reportHtml += '<th style="padding: 8px; font-weight: bold;">Ref Range</th>';
        reportHtml += '</tr>';
        reportHtml += '</thead>';
        reportHtml += '<tbody>';
        reportHtml += this.generateTargetRows(result.targetResults);
        reportHtml += '</tbody>';
        reportHtml += '</table>';

        if (result.resistanceResults && result.resistanceResults.length > 0) {
          reportHtml += '<h5 class="mt-4" style="background-color: #fff3cd; padding: 8px; border-left: 4px solid #ffc107;">';
          reportHtml += 'ANTIBIOTIC RESISTANCE';
          reportHtml += '</h5>';
          reportHtml += '<table class="report-table">';
          reportHtml += '<thead style="background-color: #e9ecef;">';
          reportHtml += '<tr>';
          reportHtml += '<th style="padding: 8px; font-weight: bold;">Test</th>';
          reportHtml += '<th style="padding: 8px; font-weight: bold;">Result</th>';
          reportHtml += '<th style="padding: 8px; font-weight: bold;">Ref Range</th>';
          reportHtml += '</tr>';
          reportHtml += '</thead>';
          reportHtml += '<tbody>';
          reportHtml += this.generateResistanceRows(result.resistanceResults);
          reportHtml += '</tbody>';
          reportHtml += '</table>';
        }

        reportHtml += '<div class="interpretation-box" style="background: #f0f8ff; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border-left: 4px solid #2196F3;">';
        reportHtml += '<h6 style="color: #2c5aa0; margin-bottom: 0.5rem;">Result Interpretation:</h6>';
        reportHtml += '<p style="margin-bottom: 0.5rem;">' + interpretationText + '</p>';
        reportHtml += '</div>';

        reportHtml += '<div style="margin-top: 30px; padding-top: 10px;" class="signature-section">';
        reportHtml += '<div class="row">';
        reportHtml += '<div class="col-md-6" style="display: inline-block; width: 45%;">';
        reportHtml += '<p style="font-size: 10px;">Tech: _________________________</p>';
        reportHtml += '</div>';
        reportHtml += '<div class="col-md-6" style="display: inline-block; width: 45%; text-align: right;">';
        reportHtml += '<p style="font-size: 10px;">Reviewed by: _________________________</p>';
        reportHtml += '</div>';
        reportHtml += '</div>';
        reportHtml += '</div>';

        $('#reportContent').html(reportHtml);
      },

      generateTargetRows: function(targetResults) {
        if (!targetResults || targetResults.length === 0) {
          return '<tr><td colspan="4">No results available</td></tr>';
        }

        let rows = '';
        targetResults.forEach(target => {
          const isDetected = target.detected || target.interpretation === 'Detected';
          const pathogenName = target.targetName || target.pathogen || 'Unknown';
          const quantValue = target.quantification?.value || target.copiesPerML || 'Not Detected';
          
          rows += '<tr>';
          rows += '<td>' + pathogenName + '</td>';
          rows += '<td' + (isDetected ? ' style="font-weight: bold; color: red;"' : '') + '>';
          rows += isDetected ? 'DETECTED' : 'Not Detected';
          rows += '</td>';
          rows += '<td>' + (isDetected && quantValue !== 'Not Detected' ? quantValue + ' copy/mL' : 'copy/mL') + '</td>';
          rows += '<td>Not Detected</td>';
          rows += '</tr>';
        });
        
        return rows;
      },

      generateResistanceRows: function(resistanceResults) {
        if (!resistanceResults || resistanceResults.length === 0) {
          return '<tr><td colspan="3">No resistance markers tested</td></tr>';
        }

        let rows = '';
        resistanceResults.forEach(marker => {
          const isDetected = marker.detected || marker.interpretation === 'Detected';
          const markerName = marker.markerName || marker.marker || 'Unknown';
          
          rows += '<tr>';
          rows += '<td>' + markerName + '</td>';
          rows += '<td' + (isDetected ? ' style="font-weight: bold; color: orange;"' : '') + '>';
          rows += isDetected ? 'DETECTED' : 'Not Detected';
          rows += '</td>';
          rows += '<td>Not Detected</td>';
          rows += '</tr>';
        });
        
        return rows;
      },

      calculateAge: function(dob) {
        if (!dob) return 'N/A';
        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
          age--;
        }
        return age;
      },

      backToList: function() {
        $('#reportView').hide();
        $('#resultsList').show();
      },

      applyFilters: function() {
        // Apply filters to results
        this.loadResults();
      },

      downloadPDF: function() {
        // For now, just use browser print to PDF
        window.print();
        // In production, you'd integrate a proper PDF library like jsPDF
      }
    };

    // Initialize when DOM is ready
    $(document).ready(() => ReportsManager.init());
  </script>
</body>
</html>
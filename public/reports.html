<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reports - Laboratory Information System</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Unified CSS files -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/theme-colors.css">
  <link rel="stylesheet" href="/css/unified-search.css">
  <link rel="stylesheet" href="/css/unified-footer.css">
  
  <style>
    /* Page-specific styles only */
    .result-card {
      background: white;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: all 0.3s;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .result-card:hover {
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .status-preliminary {
      background-color: #fff3cd;
      color: #856404;
    }

    .status-final {
      background-color: #28a745;
      color: white;
    }

    .result-positive {
      color: #dc3545;
      font-weight: bold;
    }

    .result-negative {
      color: #28a745;
    }

    .table-actions .btn {
      padding: 4px 8px;
      margin: 0 2px;
    }

    /* Report Styles */
    .report-container {
      background: white;
      padding: 2rem;
      margin: 2rem 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .report-header {
      border-bottom: 3px solid #2196F3;
      padding-bottom: 1rem;
      margin-bottom: 1.5rem;
    }

    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }

    .report-table th {
      background-color: #f5f5f5;
      padding: 0.5rem;
      text-align: left;
      border: 1px solid #ddd;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .report-table td {
      padding: 0.5rem;
      border: 1px solid #ddd;
      font-size: 0.875rem;
    }

    .lab-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }

    .interpretation-box {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      margin: 1.5rem 0;
      border-left: 4px solid #2196F3;
      font-size: 0.875rem;
    }

    .signature-line {
      border-top: 1px solid #000;
      width: 200px;
      margin-top: 3rem;
      display: inline-block;
    }

    /* Print Styles - Optimized for single page */
    @media print {
      @page {
        size: letter;
        margin: 0.3in 0.4in;
      }
      
      .no-print {
        display: none !important;
      }
      
      /* Hide navbar and header elements */
      #navbar-container {
        display: none !important;
      }
      
      nav, .navbar {
        display: none !important;
      }
      
      header {
        display: none !important;
      }
      
      .page-header {
        display: none !important;
      }
      
      body {
        background: white;
        font-size: 10px !important;
        padding-top: 0 !important;
        margin-top: 0 !important;
      }
      
      .container-fluid {
        width: 100% !important;
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
      }
      
      .report-container {
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
        box-shadow: none !important;
      }
      
      .report-header {
        page-break-after: avoid;
        border-bottom: 2px solid #2196F3 !important;
        padding-bottom: 0.3rem !important;
        margin-bottom: 0.5rem !important;
      }
      
      .report-header h3 {
        font-size: 14px !important;
        margin-bottom: 2px !important;
      }
      
      .report-header p {
        font-size: 9px !important;
        margin-bottom: 1px !important;
        line-height: 1.2 !important;
      }
      
      .report-table {
        page-break-inside: avoid;
        margin: 0.3rem 0 !important;
      }
      
      .report-table th {
        padding: 2px 4px !important;
        font-size: 9px !important;
      }
      
      .report-table td {
        padding: 2px 4px !important;
        font-size: 8px !important;
      }
      
      h5 {
        font-size: 11px !important;
        padding: 4px !important;
        margin: 0.4rem 0 0.2rem 0 !important;
      }
      
      .interpretation-box {
        padding: 0.3rem !important;
        margin: 0.5rem 0 !important;
        font-size: 8px !important;
        line-height: 1.3 !important;
      }
      
      .interpretation-box h6 {
        font-size: 9px !important;
        margin-bottom: 0.2rem !important;
      }
      
      .interpretation-box p {
        font-size: 8px !important;
        margin-bottom: 0 !important;
      }
      
      .signature-line {
        width: 150px !important;
        margin-top: 1rem !important;
      }
      
      .lab-header {
        margin-bottom: 0.3rem !important;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar will be injected here -->

  <div class="container-fluid main-content">
    <!-- Page Header -->
    <div class="page-header">
      <div class="d-flex justify-content-between align-items-center">
        <h1><i class="fas fa-file-medical me-2"></i>PCR Test Reports</h1>
        <button class="btn btn-success" onclick="ReportsManager.loadResults()">
          <i class="fas fa-sync me-2"></i>Refresh
        </button>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="section-header no-print">
      <i class="fas fa-filter"></i> Search & Filters
    </div>
    <div class="card unified-search-card no-print">
      <div class="unified-search-filters">
        <div class="search-group search-main">
          <label for="patientSearch">Patient Name/ID</label>
          <div class="search-input-wrapper">
            <input type="text" id="patientSearch" class="form-control" 
                   placeholder="Search patient...">
            <button class="search-icon" type="button" onclick="ReportsManager.applyFilters()">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
        <div class="search-group">
          <label for="statusFilter">Status</label>
          <select id="statusFilter" class="form-select">
            <option value="">All Status</option>
            <option value="Final">Final Only</option>
            <option value="Preliminary">Preliminary</option>
          </select>
        </div>
        <div class="search-group">
          <label for="resultFilter">Result</label>
          <select id="resultFilter" class="form-select">
            <option value="">All Results</option>
            <option value="Positive">Positive</option>
            <option value="Negative">Negative</option>
          </select>
        </div>
        <div class="search-group">
          <label for="fromDate">From Date</label>
          <input type="date" class="form-control" id="fromDate">
        </div>
        <div class="search-group">
          <label for="toDate">To Date</label>
          <input type="date" class="form-control" id="toDate">
        </div>
        <div class="search-actions">
          <button class="btn-search-primary" onclick="ReportsManager.applyFilters()">
            <i class="fas fa-search me-1"></i>Search
          </button>
          <button class="btn-search-secondary" onclick="ReportsManager.resetFilters()">
            <i class="fas fa-redo me-1"></i>Reset
          </button>
        </div>
      </div>
    </div>

    <!-- Results List -->
    <div class="section-header no-print">
      <i class="fas fa-list"></i> Test Results
    </div>
    <div class="card no-print">
      <div class="card-body">
        <div id="resultsList">
          <!-- Results will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Report View (Hidden by default, shown when viewing a specific report) -->
    <div id="reportView" style="display: none;">
      <div class="no-print mb-3">
        <button class="btn btn-secondary" onclick="ReportsManager.backToList()">
          <i class="fas fa-arrow-left"></i> Back to List
        </button>
        <button class="btn btn-primary" onclick="window.print()">
          <i class="fas fa-print"></i> Print Report
        </button>
        <button class="btn btn-success" onclick="ReportsManager.downloadPDF()">
          <i class="fas fa-file-pdf"></i> Download PDF
        </button>
      </div>
      
      <div id="reportContent" class="report-container">
        <!-- Report will be generated here -->
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Load auth.js first to set up AuthManager -->
  <script src="/js/auth.js"></script>

  <!-- Auth check and setup -->
  <script>
    // Check authentication using AuthManager
    if (!AuthManager.isAuthenticated()) {
      window.location.href = '/login';
    } else {
      // Set up jQuery AJAX defaults with auth headers
      $.ajaxSetup({
        headers: AuthManager.getAuthHeaders()
      });
    }
  </script>

  <!-- Load navbar after auth is confirmed -->
  <script src="/js/navbar-loader.js"></script>

  <!-- Reports Page Specific Functions -->
  <script>
    const ReportsManager = {
      results: [],
      currentResult: null,
      labSettings: null,

      init: function() {
        this.loadLabSettings();
        this.loadResults();
        
        // Load footer
        $('#footer-container').load('/components/footer.html', function(response, status, xhr) {
          if (status == "error") {
            console.error("Footer failed to load:", xhr.status, xhr.statusText);
          }
        });
        
        // Enable Enter key search
        $('#patientSearch').on('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            ReportsManager.applyFilters();
          }
        });
      },

      loadLabSettings: async function() {
        try {
          const response = await $.get('/api/settings');
          this.labSettings = response.settings;
        } catch (error) {
          console.error('Error loading lab settings:', error);
        }
      },

      loadResults: async function() {
        try {
          // Load PCR results - both Final and Preliminary (including partial results)
          const response = await $.ajax({
            url: '/api/pcr/results',
            method: 'GET',
            data: { 
              limit: 200
            }
          });

          this.results = response.results || [];
          this.displayResults();
        } catch (error) {
          console.error('Error loading results:', error);
          $('#resultsList').html('<div class="alert alert-danger">Failed to load results. Please try again.</div>');
        }
      },

      displayResults: function() {
        const container = $('#resultsList');
        
        if (this.results.length === 0) {
          container.html(`
            <div class="alert alert-info">
              <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
              <p class="text-muted">No reports available.</p>
            </div>
          `);
          return;
        }

        let html = '';
        this.results.forEach(result => {
          const date = new Date(result.performedDate || result.createdAt);
          const patient = result.patient || {};
          const overallStatus = result.overallResult?.status || 'Unknown';
          const statusClass = overallStatus === 'Positive' ? 'result-positive' : 'result-negative';
          const resultStatus = result.status || 'Preliminary';
          
          html += '<div class="result-card" onclick="ReportsManager.viewReport(\'' + result._id + '\')">';
          html += '<div class="row align-items-center">';
          html += '<div class="col-md-2">';
          html += '<strong>Order #:</strong> ' + (result.order?.orderNumber || 'N/A') + '<br>';
          html += '<small>' + date.toLocaleDateString() + '</small>';
          html += '</div>';
          html += '<div class="col-md-3">';
          html += '<strong>Patient:</strong> ' + (patient.firstName || '') + ' ' + (patient.lastName || '') + '<br>';
          html += '<small>ID: ' + (patient.patientId || 'N/A') + '</small>';
          html += '</div>';
          html += '<div class="col-md-2">';
          html += '<strong>Test:</strong> ' + (result.test?.testName || result.panel || 'PCR') + '<br>';
          html += '<strong>Order:</strong> ' + (result.order?.orderNumber || 'N/A');
          html += '</div>';
          html += '<div class="col-md-2">';
          html += '<span class="' + statusClass + '">' + overallStatus.toUpperCase() + '</span>';
          html += '</div>';
          html += '<div class="col-md-2">';
          html += '<span class="status-badge status-' + resultStatus.toLowerCase() + '">' + resultStatus + '</span>';
          html += '</div>';
          html += '<div class="col-md-1 text-end">';
          html += '<button class="btn btn-sm btn-info" onclick="event.stopPropagation(); ReportsManager.viewReport(\'' + result._id + '\')">';
          html += '<i class="fas fa-eye"></i>';
          html += '</button>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
        });

        container.html(html);
      },

      viewReport: async function(resultId) {
        try {
          const response = await $.get('/api/pcr/results/' + resultId);
          this.currentResult = response.result;
          
          // If order is just an ID, try to fetch order details
          if (typeof response.result.order === 'string') {
            try {
              const orderResponse = await $.get('/api/orders/' + response.result.order);
              response.result.order = orderResponse.order;
            } catch (e) {
              console.log('Could not fetch order details');
            }
          }
          
          this.generateReport(response.result);
          
          $('#resultsList').parent().parent().hide();
          $('.section-header.no-print').hide();
          $('.unified-search-card').hide();
          $('#reportView').show();
        } catch (error) {
          console.error('Error loading result details:', error);
          this.showMessage('Failed to load report details', 'danger');
        }
      },

      generateReport: function(result) {
        const patient = result.patient || {};
        const settings = this.labSettings || {};
        const reportDate = new Date().toLocaleDateString();
        const collectionDate = result.sampleInfo?.collectionDate ? 
          new Date(result.sampleInfo.collectionDate).toLocaleString() : 'N/A';
        const receivedDate = result.sampleInfo?.receivedDate ? 
          new Date(result.sampleInfo.receivedDate).toLocaleString() : 'N/A';
        
        // Get the actual order number
        const orderNumber = result.order?.orderNumber || result.resultNumber || 'N/A';
        
        // Determine if this is a partial result (Preliminary status)
        const isPartialResult = result.status === 'Preliminary';
        const statusText = isPartialResult ? 'PRELIMINARY' : 'FINAL';
        const statusColor = isPartialResult ? '#ffc107' : '#28a745';
        
        // Get patient sex/gender - handle all variations
        let displaySex = 'N/A';
        if (patient.gender) {
          displaySex = patient.gender.toLowerCase() === 'male' ? 'M' : 
                      patient.gender.toLowerCase() === 'female' ? 'F' : 
                      patient.gender.charAt(0).toUpperCase();
        } else if (patient.sex) {
          displaySex = patient.sex.toLowerCase() === 'male' ? 'M' : 
                      patient.sex.toLowerCase() === 'female' ? 'F' : 
                      patient.sex.charAt(0).toUpperCase();
        }
        
        // Extract phone number properly - no hardcoded values
         const labPhone = typeof settings.phone === 'object' ? 
         (settings.phone.primary || settings.phone.main || Object.values(settings.phone)[0] || '') : 
          (settings.phone || '');

           const labFax = typeof settings.fax === 'object' ? 
           (settings.fax.primary || settings.fax.main || Object.values(settings.fax)[0] || '') : 
            (settings.fax || '');
        
        // Build interpretation text
        let interpretationText = result.overallResult?.clinicalInterpretation || 
          '"Not Detected" results do not preclude urinary tract infection and should not be used as the sole basis for treatment or other patient decisions. "Detected" results are indicative of possible active urinary tract infection or coinfection with other bacteria. The pathogen(s) detected may not be the definitive cause of disease. Clinical correlation is recommended.';
        
        // Add note for partial results
        if (isPartialResult) {
          interpretationText = '<strong>Note: This is a preliminary/partial result. Additional testing may be pending.</strong><br><br>' + interpretationText;
        }
        
        let reportHtml = '';
        reportHtml += '<div class="report-header">';
        reportHtml += '<div class="lab-header">';
        reportHtml += '<div>';
        reportHtml += '<h3 style="color: #2c5aa0; margin-bottom: 5px;">MATRIX LABORATORIES</h3>';
        if (settings.labDirector && settings.labDirector.firstName) {
  const directorName = `${settings.labDirector.firstName} ${settings.labDirector.lastName || ''}`.trim();
  const directorTitle = settings.labDirector.title || '';
  if (directorTitle) {
    reportHtml += '<p class="mb-1"><strong>DIRECTOR:</strong> ' + directorName + ', ' + directorTitle + '</p>';
  } else {
    reportHtml += '<p class="mb-1"><strong>DIRECTOR:</strong> ' + directorName + '</p>';
  }
}

const labAddress = settings.address ? 
  `${settings.address.street || ''}, ${settings.address.city || ''}, ${settings.address.state || ''} ${settings.address.zipCode || ''}` : '';
if (labAddress && labAddress !== ', , ') {
  reportHtml += '<p class="mb-1">' + labAddress + '</p>';
}
        
        reportHtml += '<p class="mb-0"><strong>Phone:</strong> ' + labPhone + ' <strong>Fax:</strong> ' + labFax + '</p>';
        const labEmail = typeof settings.email === 'object' ? settings.email.general : settings.email;reportHtml += '<p class="mb-0"><strong>Email:</strong> ' + (labEmail || '') + '</p>';


        reportHtml += '</div>';
        reportHtml += '<div class="text-end">';
        reportHtml += '<span style="background-color: ' + statusColor + '; color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold;">' + statusText + '</span><br>';
        reportHtml += '<small class="text-muted mt-2">Page 1 of 1</small>';
        reportHtml += '</div>';
        reportHtml += '</div>';
        reportHtml += '</div>';

        reportHtml += '<table class="report-table mt-3">';
        reportHtml += '<tr style="background-color: #f8f9fa;">';
        reportHtml += '<td><strong>Patient:</strong> ' + (patient.firstName || '') + ' ' + (patient.lastName || '') + '</td>';
        reportHtml += '<td><strong>Accn#:</strong> ' + orderNumber + '</td>';
        reportHtml += '<td><strong>Drawn:</strong> ' + collectionDate + '</td>';
        reportHtml += '</tr>';
        reportHtml += '<tr>';
        reportHtml += '<td><strong>P.ID #:</strong> ' + (patient.patientId || 'N/A') + '</td>';
        reportHtml += '<td><strong>Dr:</strong> ' + (result.order?.orderingPhysician?.name || 'N/A') + '</td>';
        reportHtml += '<td><strong>Recvd:</strong> ' + receivedDate + '</td>';
        reportHtml += '</tr>';
        reportHtml += '<tr style="background-color: #f8f9fa;">';
        reportHtml += '<td><strong>DoB:</strong> ' + (patient.dateOfBirth ? new Date(patient.dateOfBirth).toLocaleDateString() : 'N/A') + ' <strong>Age:</strong> ' + this.calculateAge(patient.dateOfBirth) + ' <strong>Sex:</strong> ' + displaySex + '</td>';
        reportHtml += '<td><strong>Location:</strong> ' + (settings.address?.street || 'N/A') + '</td>';
        reportHtml += '<td><strong>Print:</strong> ' + reportDate + '</td>';
        reportHtml += '</tr>';
        reportHtml += '</table>';

        reportHtml += '<h5 class="mt-4" style="background-color: #e7f3ff; padding: 8px; border-left: 4px solid #2196F3;">';
        reportHtml += 'MOLECULAR ' + (result.panel || result.test?.panel || 'UTI') + ' PANEL (PCR)';
        reportHtml += '</h5>';
        
        reportHtml += '<table class="report-table">';
        reportHtml += '<thead style="background-color: #e9ecef;">';
        reportHtml += '<tr>';
        reportHtml += '<th style="padding: 8px; font-weight: bold;">Test</th>';
        reportHtml += '<th style="padding: 8px; font-weight: bold;">Result</th>';
        reportHtml += '<th style="padding: 8px; font-weight: bold;">Units</th>';
        reportHtml += '<th style="padding: 8px; font-weight: bold;">Ref Range</th>';
        reportHtml += '</tr>';
        reportHtml += '</thead>';
        reportHtml += '<tbody>';
        reportHtml += this.generateTargetRows(result.targetResults);
        reportHtml += '</tbody>';
        reportHtml += '</table>';

        if (result.resistanceResults && result.resistanceResults.length > 0) {
          reportHtml += '<h5 class="mt-4" style="background-color: #fff3cd; padding: 8px; border-left: 4px solid #ffc107;">';
          reportHtml += 'ANTIBIOTIC RESISTANCE';
          reportHtml += '</h5>';
          reportHtml += '<table class="report-table">';
          reportHtml += '<thead style="background-color: #e9ecef;">';
          reportHtml += '<tr>';
          reportHtml += '<th style="padding: 8px; font-weight: bold;">Test</th>';
          reportHtml += '<th style="padding: 8px; font-weight: bold;">Result</th>';
          reportHtml += '<th style="padding: 8px; font-weight: bold;">Ref Range</th>';
          reportHtml += '</tr>';
          reportHtml += '</thead>';
          reportHtml += '<tbody>';
          reportHtml += this.generateResistanceRows(result.resistanceResults);
          reportHtml += '</tbody>';
          reportHtml += '</table>';
        }

        reportHtml += '<div class="interpretation-box" style="background: #f0f8ff; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border-left: 4px solid #2196F3;">';
        reportHtml += '<h6 style="color: #2c5aa0; margin-bottom: 0.5rem;">Result Interpretation:</h6>';
        reportHtml += '<p style="margin-bottom: 0.5rem;">' + interpretationText + '</p>';
        reportHtml += '</div>';

        reportHtml += '<div style="margin-top: 30px; padding-top: 10px;" class="signature-section">';
        reportHtml += '<div class="row">';
        reportHtml += '<div class="col-md-6" style="display: inline-block; width: 45%;">';
        reportHtml += '<p style="font-size: 10px;">Tech: _________________________</p>';
        reportHtml += '</div>';
        reportHtml += '<div class="col-md-6" style="display: inline-block; width: 45%; text-align: right;">';
        reportHtml += '<p style="font-size: 10px;">Reviewed by: _________________________</p>';
        reportHtml += '</div>';
        reportHtml += '</div>';
        reportHtml += '</div>';

        $('#reportContent').html(reportHtml);
      },

      generateTargetRows: function(targetResults) {
        if (!targetResults || targetResults.length === 0) {
          return '<tr><td colspan="4">No results available</td></tr>';
        }

        let rows = '';
        targetResults.forEach(target => {
          const isDetected = target.detected || target.interpretation === 'Detected';
          const pathogenName = target.targetName || target.pathogen || 'Unknown';
          const quantValue = target.quantification?.value || target.copiesPerML || 'Not Detected';
          
          rows += '<tr>';
          rows += '<td>' + pathogenName + '</td>';
          rows += '<td' + (isDetected ? ' style="font-weight: bold; color: red;"' : '') + '>';
          rows += isDetected ? 'DETECTED' : 'Not Detected';
          rows += '</td>';
          rows += '<td>' + (isDetected && quantValue !== 'Not Detected' ? quantValue + ' copy/mL' : 'copy/mL') + '</td>';
          rows += '<td>Not Detected</td>';
          rows += '</tr>';
        });
        
        return rows;
      },

      generateResistanceRows: function(resistanceResults) {
        if (!resistanceResults || resistanceResults.length === 0) {
          return '<tr><td colspan="3">No resistance markers tested</td></tr>';
        }

        let rows = '';
        resistanceResults.forEach(marker => {
          const isDetected = marker.detected || marker.interpretation === 'Detected';
          const markerName = marker.markerName || marker.marker || 'Unknown';
          
          rows += '<tr>';
          rows += '<td>' + markerName + '</td>';
          rows += '<td' + (isDetected ? ' style="font-weight: bold; color: orange;"' : '') + '>';
          rows += isDetected ? 'DETECTED' : 'Not Detected';
          rows += '</td>';
          rows += '<td>Not Detected</td>';
          rows += '</tr>';
        });
        
        return rows;
      },

      calculateAge: function(dob) {
        if (!dob) return 'N/A';
        const birthDate = new Date(dob);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
          age--;
        }
        return age;
      },

      backToList: function() {
        $('#reportView').hide();
        $('#resultsList').parent().parent().show();
        $('.section-header.no-print').show();
        $('.unified-search-card').show();
      },

      resetFilters: function() {
        $('#patientSearch').val('');
        $('#statusFilter').val('');
        $('#resultFilter').val('');
        $('#fromDate').val('');
        $('#toDate').val('');
        this.loadResults();
      },

      applyFilters: function() {
        const patientSearch = $('#patientSearch').val().toLowerCase();
        const statusFilter = $('#statusFilter').val();
        const resultFilter = $('#resultFilter').val();
        const fromDate = $('#fromDate').val();
        const toDate = $('#toDate').val();

        let filteredResults = this.results;

        // Apply patient search filter
        if (patientSearch) {
          filteredResults = filteredResults.filter(result => {
            const patient = result.patient || {};
            const fullName = `${patient.firstName || ''} ${patient.lastName || ''}`.toLowerCase();
            const patientId = (patient.patientId || '').toLowerCase();
            return fullName.includes(patientSearch) || patientId.includes(patientSearch);
          });
        }

        // Apply status filter
        if (statusFilter) {
          filteredResults = filteredResults.filter(result => result.status === statusFilter);
        }

        // Apply result filter
        if (resultFilter) {
          filteredResults = filteredResults.filter(result => 
            result.overallResult?.status === resultFilter
          );
        }

        // Apply date filters
        if (fromDate) {
          const from = new Date(fromDate);
          filteredResults = filteredResults.filter(result => 
            new Date(result.performedDate || result.createdAt) >= from
          );
        }

        if (toDate) {
          const to = new Date(toDate);
          to.setHours(23, 59, 59, 999);
          filteredResults = filteredResults.filter(result => 
            new Date(result.performedDate || result.createdAt) <= to
          );
        }

        // Store filtered results temporarily and display them
        const tempResults = this.results;
        this.results = filteredResults;
        this.displayResults();
        this.results = tempResults; // Restore original results
      },

      downloadPDF: async function() {
        if (!this.currentResult) {
          this.showMessage('No report loaded', 'warning');
          return;
        }

        try {
          // Show loading indicator
          const downloadBtn = event.target.closest('button');
          const originalHtml = downloadBtn.innerHTML;
          downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
          downloadBtn.disabled = true;

          // Create a temporary container for the PDF content
          const tempContainer = document.createElement('div');
          tempContainer.style.position = 'absolute';
          tempContainer.style.left = '-9999px';
          tempContainer.style.width = '8.5in';
          tempContainer.style.backgroundColor = 'white';
          tempContainer.style.padding = '0.5in';
          document.body.appendChild(tempContainer);

          // Clone the report content
          const reportClone = document.getElementById('reportContent').cloneNode(true);
          tempContainer.appendChild(reportClone);

          // Use html2canvas to capture the content
          const canvas = await html2canvas(tempContainer, {
            scale: 2,
            useCORS: true,
            logging: false,
            windowWidth: 816, // 8.5 inches at 96 DPI
            windowHeight: 1056 // 11 inches at 96 DPI
          });

          // Convert to PDF using jsPDF
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'letter'
          });

          // Calculate dimensions
          const imgWidth = 210; // A4 width in mm
          const pageHeight = 297; // A4 height in mm
          const imgHeight = (canvas.height * imgWidth) / canvas.width;

          // Add image to PDF
          const imgData = canvas.toDataURL('image/png');
          pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

          // Generate filename
          const patient = this.currentResult.patient || {};
          const date = new Date().toISOString().split('T')[0];
          const filename = `PCR_Report_${patient.lastName || 'Patient'}_${patient.firstName || ''}_${date}.pdf`;

          // Download the PDF
          pdf.save(filename);

          // Clean up
          document.body.removeChild(tempContainer);

          // Restore button
          downloadBtn.innerHTML = originalHtml;
          downloadBtn.disabled = false;

        } catch (error) {
          console.error('Error generating PDF:', error);
          this.showMessage('Failed to generate PDF. Please try printing instead.', 'danger');
          
          // Restore button on error
          const downloadBtn = event.target.closest('button');
          if (downloadBtn) {
            downloadBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Download PDF';
            downloadBtn.disabled = false;
          }
        }
      },

      // Helper function to show success/error messages
      showMessage: function(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'warning' ? 'alert-warning' : 'alert-danger';
        const alertHtml = `
          <div class="alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-5" style="z-index: 9999;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `;
        $('body').append(alertHtml);
        setTimeout(() => {
          $('.alert').fadeOut(() => $('.alert').remove());
        }, 3000);
      }
    };

    // Initialize when DOM is ready
    $(document).ready(() => ReportsManager.init());
  </script>

  <!-- Footer container -->
  <div id="footer-container"></div>
</body>
</html>
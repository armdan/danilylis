<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patients - Laboratory Information System</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Main CSS FIRST -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/theme-colors.css">
  
  <!-- Component CSS AFTER main.css -->
  <link rel="stylesheet" href="/css/unified-search.css">
  <link rel="stylesheet" href="/css/unified-footer.css">

  <!-- Page-specific styles -->
  <style>
    /* Patient-specific styles */
    .patient-badge {
      font-size: 0.875rem;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
    }
    
    /* Add hover effect to section headers */
    .section-header {
      transition: all 0.3s ease;
    }
    
    .section-header:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <!-- Navbar will be injected here by navbar-loader.js -->

  <!-- Main Content -->
  <div class="container-fluid main-content">
    <!-- Page Header -->
    <div class="page-header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="page-title">
            <i class="fas fa-users me-2"></i>Patient Management
          </h1>
          <p class="page-subtitle">Manage patient records and information</p>
        </div>
        <button class="btn btn-light" id="addPatientBtn">
          <i class="fas fa-plus me-2"></i>Add New Patient
        </button>
      </div>
    </div>

    <!-- Search and Filters Section -->
    <div class="section-header">
      <i class="fas fa-filter"></i> Search & Filters
    </div>
    <div class="card unified-search-card">
      <div class="unified-search-filters">
        <div class="search-group search-main">
          <label for="searchInput">Search Patients</label>
          <div class="search-input-wrapper">
            <input type="text" class="form-control" id="searchInput" 
                   placeholder="Name, ID, Phone, Email...">
            <button class="search-icon" type="button" id="searchBtn">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
        <div class="search-group">
          <label for="genderFilter">Gender</label>
          <select class="form-select" id="genderFilter">
            <option value="">All</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="search-group">
          <label for="statusFilter">Status</label>
          <select class="form-select" id="statusFilter">
            <option value="">All</option>
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>
        <div class="search-group">
          <label for="limitSelect">Show</label>
          <select class="form-select" id="limitSelect">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        <div class="search-actions">
          <button class="btn btn-primary btn-search-primary" id="searchBtn2">
            <i class="fas fa-search me-1"></i>Search
          </button>
          <button class="btn btn-outline-secondary btn-search-secondary" id="clearFiltersBtn">
            <i class="fas fa-times me-1"></i>Clear
          </button>
        </div>
      </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <!-- Patients Table Section -->
    <div class="section-header">
      <i class="fas fa-list"></i> Patient List
      <span class="badge bg-primary ms-2" id="patientCount">0</span>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Patient ID</th>
                <th>Name</th>
                <th>Date of Birth</th>
                <th>Gender</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="patientsTableBody">
              <tr>
                <td colspan="8" class="text-center py-4">
                  <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                  Loading patients...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="Patient pagination">
          <ul class="pagination justify-content-center" id="pagination"></ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- Footer container -->
  <div id="footer-container"></div>

  <!-- Add/Edit Patient Modal with Tabs -->
  <div class="modal fade" id="patientModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="patientModalTitle">Add New Patient</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="patientForm" class="needs-validation" novalidate>
            <input type="hidden" id="patientId">
            
            <!-- Nav tabs -->
            <ul class="nav nav-tabs mb-3" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#personalTab">Personal Information</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#addressTab">Contact & Address</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#insuranceTab">Insurance</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#billingTab">Billing</a>
              </li>
            </ul>

            <!-- Tab content -->
            <div class="tab-content">
              <!-- Personal Information Tab -->
              <div class="tab-pane fade show active" id="personalTab">
                <h6 class="mb-3 text-primary">Personal Information</h6>
                <div class="row g-3 mb-4">
                  <div class="col-md-6">
                    <label class="form-label">First Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="firstName" required>
                    <div class="invalid-feedback">First name is required</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Last Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="lastName" required>
                    <div class="invalid-feedback">Last name is required</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="dateOfBirth" required>
                    <div class="invalid-feedback">Date of birth is required</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Gender <span class="text-danger">*</span></label>
                    <select class="form-select" id="gender" required>
                      <option value="">Select Gender</option>
                      <option value="male">Male</option>
                      <option value="female">Female</option>
                      <option value="other">Other</option>
                    </select>
                    <div class="invalid-feedback">Please select a gender</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Phone Number <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" id="phone" required>
                    <div class="invalid-feedback">Phone number is required</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="email">
                  </div>
                </div>

                <h6 class="mb-3 text-primary">Emergency Contact</h6>
                <div class="row g-3 mb-4">
                  <div class="col-md-6">
                    <label class="form-label">Contact Name</label>
                    <input type="text" class="form-control" id="emergencyContactName">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Contact Phone</label>
                    <input type="tel" class="form-control" id="emergencyContactPhone">
                  </div>
                  <div class="col-12">
                    <label class="form-label">Relationship</label>
                    <input type="text" class="form-control" id="emergencyContactRelationship" 
                           placeholder="e.g., Spouse, Parent, Sibling">
                  </div>
                </div>
              </div>

              <!-- Contact & Address Tab -->
              <div class="tab-pane fade" id="addressTab">
                <h6 class="mb-3 text-primary">Address Information</h6>
                <div class="row g-3 mb-4">
                  <div class="col-12">
                    <label class="form-label">Street Address</label>
                    <input type="text" class="form-control" id="street">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">City</label>
                    <input type="text" class="form-control" id="city">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">State</label>
                    <input type="text" class="form-control" id="state">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">ZIP Code</label>
                    <input type="text" class="form-control" id="zipCode">
                  </div>
                </div>
              </div>

              <!-- Insurance Tab -->
              <div class="tab-pane fade" id="insuranceTab">
                <h6 class="mb-3 text-primary">Primary Insurance</h6>
                <div class="row g-3 mb-4">
                  <div class="col-md-6">
                    <label class="form-label">Insurance Provider</label>
                    <input type="text" class="form-control" id="primaryInsuranceProvider" 
                           placeholder="e.g., Blue Cross Blue Shield">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Plan Name</label>
                    <input type="text" class="form-control" id="primaryInsurancePlanName">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Policy Number</label>
                    <input type="text" class="form-control" id="primaryInsurancePolicyNumber">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Group Number</label>
                    <input type="text" class="form-control" id="primaryInsuranceGroupNumber">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Subscriber ID</label>
                    <input type="text" class="form-control" id="primaryInsuranceSubscriberId">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Subscriber Name</label>
                    <input type="text" class="form-control" id="primaryInsuranceSubscriberName" 
                           placeholder="If different from patient">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Relationship to Subscriber</label>
                    <select class="form-select" id="primaryInsuranceRelationship">
                      <option value="self">Self</option>
                      <option value="spouse">Spouse</option>
                      <option value="child">Child</option>
                      <option value="parent">Parent</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Effective Date</label>
                    <input type="date" class="form-control" id="primaryInsuranceEffectiveDate">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Copay Amount</label>
                    <input type="number" class="form-control" id="primaryInsuranceCopay" 
                           min="0" step="0.01" placeholder="0.00">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Deductible</label>
                    <input type="number" class="form-control" id="primaryInsuranceDeductible" 
                           min="0" step="0.01" placeholder="0.00">
                  </div>
                </div>

                <h6 class="mb-3 text-primary">Medicare/Medicaid</h6>
                <div class="row g-3 mb-4">
                  <div class="col-md-6">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="hasMedicare">
                      <label class="form-check-label" for="hasMedicare">
                        Patient has Medicare
                      </label>
                    </div>
                    <input type="text" class="form-control mt-2" id="medicareNumber" 
                           placeholder="Medicare Number" style="display:none;">
                  </div>
                  <div class="col-md-6">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="hasMedicaid">
                      <label class="form-check-label" for="hasMedicaid">
                        Patient has Medicaid
                      </label>
                    </div>
                    <input type="text" class="form-control mt-2" id="medicaidNumber" 
                           placeholder="Medicaid Number" style="display:none;">
                  </div>
                </div>
              </div>

              <!-- Billing Tab -->
              <div class="tab-pane fade" id="billingTab">
                <h6 class="mb-3 text-primary">Billing Preferences</h6>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Preferred Payment Method</label>
                    <select class="form-select" id="preferredPaymentMethod">
                      <option value="insurance">Insurance</option>
                      <option value="self-pay">Self Pay</option>
                      <option value="payment-plan">Payment Plan</option>
                      <option value="credit-card">Credit Card</option>
                      <option value="cash">Cash</option>
                      <option value="check">Check</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Billing Email</label>
                    <input type="email" class="form-control" id="billingEmail" 
                           placeholder="For statements and invoices">
                  </div>
                  <div class="col-md-6">
                    <div class="form-check mt-4">
                      <input class="form-check-input" type="checkbox" id="paperlessBilling">
                      <label class="form-check-label" for="paperlessBilling">
                        Paperless Billing (Email only)
                      </label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-check mt-4">
                      <input class="form-check-input" type="checkbox" id="isGuarantor">
                      <label class="form-check-label" for="isGuarantor">
                        Patient is the guarantor
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="savePatientBtn">
            <i class="fas fa-save me-2"></i>Save Patient
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Patient Details Modal -->
  <div class="modal fade" id="patientDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Patient Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="patientDetailsContent">
          <!-- Patient details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="editFromDetailsBtn">
            <i class="fas fa-edit me-2"></i>Edit Patient
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts in correct order -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/navbar-loader.js"></script>

  <!-- Load Footer -->
  <script>
    $(document).ready(function() {
      $('#footer-container').load('/components/footer.html');
    });
  </script>

  <!-- Page-specific script -->
  <script>
    // Patient Management System
    const PatientManager = {
      currentPage: 1,
      currentPatientId: null,
      patientModal: null,
      detailsModal: null,

      init() {
        // Check authentication
        if (!this.checkAuth()) return;

        // Initialize Bootstrap modals
        this.patientModal = new bootstrap.Modal(document.getElementById('patientModal'));
        this.detailsModal = new bootstrap.Modal(document.getElementById('patientDetailsModal'));

        // Setup event handlers
        this.setupEventHandlers();

        // Load initial data
        this.loadPatients(1);

        // Ensure navbar shows correct user
        this.ensureNavbarUpdate();
      },

      checkAuth() {
        if (typeof AuthManager === 'undefined' || !AuthManager.isAuthenticated()) {
          console.log('Not authenticated, redirecting to login...');
          window.location.href = '/login';
          return false;
        }
        return true;
      },

      ensureNavbarUpdate() {
        const updateNavbar = () => {
          const user = AuthManager.getUser();
          if (user) {
            const userNameEl = document.getElementById('userName');
            if (userNameEl) {
              const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.username || 'User';
              userNameEl.textContent = fullName;
            }
          }
        };

        // Try multiple times to ensure navbar is loaded
        updateNavbar();
        setTimeout(updateNavbar, 100);
        setTimeout(updateNavbar, 500);
        setTimeout(updateNavbar, 1000);
      },

      setupEventHandlers() {
        // Add patient button
        document.getElementById('addPatientBtn').addEventListener('click', () => {
          this.showAddPatientModal();
        });

        // Save patient button
        document.getElementById('savePatientBtn').addEventListener('click', () => {
          this.savePatient();
        });

        // Edit from details button
        document.getElementById('editFromDetailsBtn').addEventListener('click', () => {
          this.editPatientFromDetails();
        });

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchBtn2 = document.getElementById('searchBtn2');
        
        searchBtn.addEventListener('click', () => this.searchPatients());
        searchBtn2.addEventListener('click', () => this.searchPatients());
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') this.searchPatients();
        });

        // Filter handlers
        ['genderFilter', 'statusFilter', 'limitSelect'].forEach(id => {
          document.getElementById(id).addEventListener('change', () => {
            this.filterPatients();
          });
        });

        // Clear filters
        document.getElementById('clearFiltersBtn').addEventListener('click', () => {
          this.clearFilters();
        });

        // Medicare/Medicaid checkboxes
        document.getElementById('hasMedicare').addEventListener('change', (e) => {
          document.getElementById('medicareNumber').style.display = 
            e.target.checked ? 'block' : 'none';
        });

        document.getElementById('hasMedicaid').addEventListener('change', (e) => {
          document.getElementById('medicaidNumber').style.display = 
            e.target.checked ? 'block' : 'none';
        });
      },

      showAddPatientModal() {
        this.currentPatientId = null;
        document.getElementById('patientModalTitle').textContent = 'Add New Patient';
        document.getElementById('patientForm').reset();
        document.getElementById('patientForm').classList.remove('was-validated');
        this.patientModal.show();
      },

      async loadPatients(page = 1) {
        try {
          const limit = document.getElementById('limitSelect').value;
          const search = document.getElementById('searchInput').value;
          const gender = document.getElementById('genderFilter').value;
          const isActive = document.getElementById('statusFilter').value;

          let url = `/api/patients?page=${page}&limit=${limit}`;
          if (search) url += `&search=${encodeURIComponent(search)}`;
          if (gender) url += `&gender=${gender}`;
          if (isActive !== '') url += `&isActive=${isActive}`;

          const response = await fetch(url, {
            headers: AuthManager.getAuthHeaders()
          });

          if (!response.ok) {
            if (response.status === 401) {
              AuthManager.logout();
              return;
            }
            throw new Error(`Failed to load patients: ${response.status}`);
          }

          const data = await response.json();
          this.displayPatients(data.patients);
          this.updatePagination(data.pagination);
          this.updatePatientCount(data.pagination.total);
          this.currentPage = page;

        } catch (error) {
          console.error('Error loading patients:', error);
          this.showAlert('danger', 'Failed to load patients');
        }
      },

      displayPatients(patients) {
        const tbody = document.getElementById('patientsTableBody');
        
        if (patients.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                <i class="fas fa-users me-2"></i>No patients found
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = patients.map(patient => {
          const genderBadgeClass = {
            male: 'primary',
            female: 'info',
            other: 'secondary'
          }[patient.gender] || 'secondary';

          return `
            <tr>
              <td><strong>${patient.patientId || 'N/A'}</strong></td>
              <td><strong>${patient.firstName} ${patient.lastName}</strong></td>
              <td>${this.formatDate(patient.dateOfBirth)}</td>
              <td>
                <span class="badge bg-${genderBadgeClass} patient-badge">
                  ${this.capitalize(patient.gender)}
                </span>
              </td>
              <td><a href="tel:${patient.phone}" class="text-decoration-none">${patient.phone}</a></td>
              <td>${patient.email ? 
                `<a href="mailto:${patient.email}" class="text-decoration-none">${patient.email}</a>` : 
                '<span class="text-muted">-</span>'}</td>
              <td>
                <span class="badge bg-${patient.isActive ? 'success' : 'secondary'} patient-badge">
                  ${patient.isActive ? 'Active' : 'Inactive'}
                </span>
              </td>
              <td>
                <div class="btn-action-group">
                  <button class="btn btn-sm btn-outline-primary" onclick="PatientManager.viewPatientDetails('${patient._id}')" 
                          title="View Details">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-success" onclick="PatientManager.editPatient('${patient._id}')" 
                          title="Edit">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-info" onclick="PatientManager.viewPatientOrders('${patient._id}')" 
                          title="View Orders">
                    <i class="fas fa-clipboard-list"></i>
                  </button>
                </div>
              </td>
            </tr>
          `;
        }).join('');
      },

      async savePatient() {
        const form = document.getElementById('patientForm');
        
        // Bootstrap 5 validation
        if (!form.checkValidity()) {
          form.classList.add('was-validated');
          return;
        }

        try {
          const patientData = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            dateOfBirth: document.getElementById('dateOfBirth').value,
            gender: document.getElementById('gender').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value || undefined,
            address: {
              street: document.getElementById('street').value || undefined,
              city: document.getElementById('city').value || undefined,
              state: document.getElementById('state').value || undefined,
              zipCode: document.getElementById('zipCode').value || undefined
            },
            emergencyContact: {
              name: document.getElementById('emergencyContactName').value || undefined,
              phone: document.getElementById('emergencyContactPhone').value || undefined,
              relationship: document.getElementById('emergencyContactRelationship').value || undefined
            },
            billing: {
              primaryInsurance: {
                provider: document.getElementById('primaryInsuranceProvider').value || undefined,
                planName: document.getElementById('primaryInsurancePlanName').value || undefined,
                policyNumber: document.getElementById('primaryInsurancePolicyNumber').value || undefined,
                groupNumber: document.getElementById('primaryInsuranceGroupNumber').value || undefined,
                subscriberId: document.getElementById('primaryInsuranceSubscriberId').value || undefined,
                subscriberName: document.getElementById('primaryInsuranceSubscriberName').value || undefined,
                subscriberRelationship: document.getElementById('primaryInsuranceRelationship').value || 'self',
                effectiveDate: document.getElementById('primaryInsuranceEffectiveDate').value || undefined,
                copayAmount: parseFloat(document.getElementById('primaryInsuranceCopay').value) || undefined,
                deductible: parseFloat(document.getElementById('primaryInsuranceDeductible').value) || undefined
              },
              medicare: {
                hasMedicare: document.getElementById('hasMedicare').checked,
                medicareNumber: document.getElementById('hasMedicare').checked ? 
                  document.getElementById('medicareNumber').value || undefined : undefined
              },
              medicaid: {
                hasMedicaid: document.getElementById('hasMedicaid').checked,
                medicaidNumber: document.getElementById('hasMedicaid').checked ? 
                  document.getElementById('medicaidNumber').value || undefined : undefined
              },
              billingPreferences: {
                preferredPaymentMethod: document.getElementById('preferredPaymentMethod').value,
                billingEmail: document.getElementById('billingEmail').value || undefined,
                paperlessBilling: document.getElementById('paperlessBilling').checked
              },
              guarantor: {
                isPatientGuarantor: document.getElementById('isGuarantor').checked
              }
            }
          };

          // Clean up empty objects
          if (!Object.values(patientData.address).some(v => v)) {
            delete patientData.address;
          }
          if (!Object.values(patientData.emergencyContact).some(v => v)) {
            delete patientData.emergencyContact;
          }
          if (!Object.values(patientData.billing.primaryInsurance).some(v => v && v !== 'self')) {
            delete patientData.billing.primaryInsurance;
          }

          const isEdit = this.currentPatientId !== null;
          const url = isEdit ? `/api/patients/${this.currentPatientId}` : '/api/patients';
          const method = isEdit ? 'PUT' : 'POST';

          const response = await fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json',
              ...AuthManager.getAuthHeaders()
            },
            body: JSON.stringify(patientData)
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Failed to save patient');
          }

          this.patientModal.hide();
          this.showAlert('success', isEdit ? 'Patient updated successfully' : 'Patient created successfully');
          this.loadPatients(this.currentPage);

        } catch (error) {
          console.error('Error saving patient:', error);
          this.showAlert('danger', error.message);
        }
      },

      async editPatient(patientId) {
        try {
          const response = await fetch(`/api/patients/${patientId}`, {
            headers: AuthManager.getAuthHeaders()
          });

          if (!response.ok) {
            throw new Error('Failed to load patient');
          }

          const data = await response.json();
          const patient = data.patient;

          // Populate form
          this.currentPatientId = patientId;
          document.getElementById('patientModalTitle').textContent = 'Edit Patient';
          document.getElementById('firstName').value = patient.firstName;
          document.getElementById('lastName').value = patient.lastName;
          document.getElementById('dateOfBirth').value = patient.dateOfBirth.split('T')[0];
          document.getElementById('gender').value = patient.gender;
          document.getElementById('phone').value = patient.phone;
          document.getElementById('email').value = patient.email || '';
          
          // Address
          if (patient.address) {
            document.getElementById('street').value = patient.address.street || '';
            document.getElementById('city').value = patient.address.city || '';
            document.getElementById('state').value = patient.address.state || '';
            document.getElementById('zipCode').value = patient.address.zipCode || '';
          }

          // Emergency contact
          if (patient.emergencyContact) {
            document.getElementById('emergencyContactName').value = patient.emergencyContact.name || '';
            document.getElementById('emergencyContactPhone').value = patient.emergencyContact.phone || '';
            document.getElementById('emergencyContactRelationship').value = patient.emergencyContact.relationship || '';
          }

          // Billing and Insurance
          if (patient.billing) {
            // Primary Insurance
            if (patient.billing.primaryInsurance) {
              const pi = patient.billing.primaryInsurance;
              document.getElementById('primaryInsuranceProvider').value = pi.provider || '';
              document.getElementById('primaryInsurancePlanName').value = pi.planName || '';
              document.getElementById('primaryInsurancePolicyNumber').value = pi.policyNumber || '';
              document.getElementById('primaryInsuranceGroupNumber').value = pi.groupNumber || '';
              document.getElementById('primaryInsuranceSubscriberId').value = pi.subscriberId || '';
              document.getElementById('primaryInsuranceSubscriberName').value = pi.subscriberName || '';
              document.getElementById('primaryInsuranceRelationship').value = pi.subscriberRelationship || 'self';
              if (pi.effectiveDate) {
                document.getElementById('primaryInsuranceEffectiveDate').value = pi.effectiveDate.split('T')[0];
              }
              document.getElementById('primaryInsuranceCopay').value = pi.copayAmount || '';
              document.getElementById('primaryInsuranceDeductible').value = pi.deductible || '';
            }

            // Medicare
            if (patient.billing.medicare) {
              document.getElementById('hasMedicare').checked = patient.billing.medicare.hasMedicare || false;
              if (patient.billing.medicare.hasMedicare) {
                document.getElementById('medicareNumber').value = patient.billing.medicare.medicareNumber || '';
                document.getElementById('medicareNumber').style.display = 'block';
              }
            }

            // Medicaid
            if (patient.billing.medicaid) {
              document.getElementById('hasMedicaid').checked = patient.billing.medicaid.hasMedicaid || false;
              if (patient.billing.medicaid.hasMedicaid) {
                document.getElementById('medicaidNumber').value = patient.billing.medicaid.medicaidNumber || '';
                document.getElementById('medicaidNumber').style.display = 'block';
              }
            }

            // Billing Preferences
            if (patient.billing.billingPreferences) {
              const bp = patient.billing.billingPreferences;
              document.getElementById('preferredPaymentMethod').value = bp.preferredPaymentMethod || 'insurance';
              document.getElementById('billingEmail').value = bp.billingEmail || '';
              document.getElementById('paperlessBilling').checked = bp.paperlessBilling || false;
            }

            // Guarantor
            if (patient.billing.guarantor) {
              document.getElementById('isGuarantor').checked = patient.billing.guarantor.isPatientGuarantor || true;
            }
          }

          this.patientModal.show();

        } catch (error) {
          console.error('Error loading patient:', error);
          this.showAlert('danger', 'Failed to load patient details');
        }
      },

      async viewPatientDetails(patientId) {
        try {
          this.currentPatientId = patientId;
          const response = await fetch(`/api/patients/${patientId}`, {
            headers: AuthManager.getAuthHeaders()
          });

          if (!response.ok) {
            throw new Error('Failed to load patient details');
          }

          const data = await response.json();
          const patient = data.patient;

          // Get insurance status
          let insuranceStatus = 'Self-Pay';
          let insuranceDetails = '';
          if (patient.billing) {
            if (patient.billing.primaryInsurance?.provider) {
              insuranceStatus = patient.billing.primaryInsurance.provider;
              insuranceDetails = `Policy: ${patient.billing.primaryInsurance.policyNumber || 'N/A'}`;
            } else if (patient.billing.medicare?.hasMedicare) {
              insuranceStatus = 'Medicare';
              insuranceDetails = `Medicare #: ${patient.billing.medicare.medicareNumber || 'N/A'}`;
            } else if (patient.billing.medicaid?.hasMedicaid) {
              insuranceStatus = 'Medicaid';
              insuranceDetails = `Medicaid #: ${patient.billing.medicaid.medicaidNumber || 'N/A'}`;
            }
          }

          const detailsHtml = `
            <div class="row">
              <div class="col-md-6">
                <h6 class="text-primary mb-3"><i class="fas fa-user me-2"></i>Personal Information</h6>
                <table class="table table-sm">
                  <tr><td class="fw-bold">Patient ID:</td><td>${patient.patientId}</td></tr>
                  <tr><td class="fw-bold">Name:</td><td>${patient.firstName} ${patient.lastName}</td></tr>
                  <tr><td class="fw-bold">Date of Birth:</td><td>${this.formatDate(patient.dateOfBirth)}</td></tr>
                  <tr><td class="fw-bold">Age:</td><td>${this.calculateAge(patient.dateOfBirth)} years</td></tr>
                  <tr><td class="fw-bold">Gender:</td><td>${this.capitalize(patient.gender)}</td></tr>
                  <tr><td class="fw-bold">Phone:</td><td><a href="tel:${patient.phone}">${patient.phone}</a></td></tr>
                  <tr><td class="fw-bold">Email:</td><td>${patient.email ? 
                    `<a href="mailto:${patient.email}">${patient.email}</a>` : 'Not provided'}</td></tr>
                  <tr><td class="fw-bold">Status:</td><td>
                    <span class="badge bg-${patient.isActive ? 'success' : 'secondary'}">
                      ${patient.isActive ? 'Active' : 'Inactive'}
                    </span>
                  </td></tr>
                </table>
              </div>
              <div class="col-md-6">
                <h6 class="text-primary mb-3"><i class="fas fa-map-marker-alt me-2"></i>Address</h6>
                <table class="table table-sm">
                  <tr><td class="fw-bold">Street:</td><td>${patient.address?.street || 'Not provided'}</td></tr>
                  <tr><td class="fw-bold">City:</td><td>${patient.address?.city || 'Not provided'}</td></tr>
                  <tr><td class="fw-bold">State:</td><td>${patient.address?.state || 'Not provided'}</td></tr>
                  <tr><td class="fw-bold">ZIP:</td><td>${patient.address?.zipCode || 'Not provided'}</td></tr>
                </table>
                
                <h6 class="text-primary mb-3 mt-4"><i class="fas fa-phone-alt me-2"></i>Emergency Contact</h6>
                <table class="table table-sm">
                  <tr><td class="fw-bold">Name:</td><td>${patient.emergencyContact?.name || 'Not provided'}</td></tr>
                  <tr><td class="fw-bold">Phone:</td><td>${patient.emergencyContact?.phone ? 
                    `<a href="tel:${patient.emergencyContact.phone}">${patient.emergencyContact.phone}</a>` : 
                    'Not provided'}</td></tr>
                  <tr><td class="fw-bold">Relationship:</td><td>${patient.emergencyContact?.relationship || 'Not provided'}</td></tr>
                </table>
              </div>
            </div>
            
            <div class="row mt-4">
              <div class="col-md-6">
                <h6 class="text-primary mb-3"><i class="fas fa-file-medical me-2"></i>Insurance Information</h6>
                <table class="table table-sm">
                  <tr><td class="fw-bold">Coverage:</td><td>
                    <span class="badge bg-${insuranceStatus === 'Self-Pay' ? 'warning' : 'info'}">
                      ${insuranceStatus}
                    </span>
                  </td></tr>
                  ${insuranceDetails ? `<tr><td class="fw-bold">Details:</td><td>${insuranceDetails}</td></tr>` : ''}
                  ${patient.billing?.primaryInsurance ? `
                    <tr><td class="fw-bold">Group #:</td><td>${patient.billing.primaryInsurance.groupNumber || 'N/A'}</td></tr>
                    <tr><td class="fw-bold">Copay:</td><td>${patient.billing.primaryInsurance.copayAmount || 0}</td></tr>
                    <tr><td class="fw-bold">Deductible:</td><td>${patient.billing.primaryInsurance.deductible || 0}</td></tr>
                  ` : ''}
                  <tr><td class="fw-bold">Payment Method:</td><td>
                    ${patient.billing?.billingPreferences?.preferredPaymentMethod || 'Insurance'}
                  </td></tr>
                </table>
              </div>
              <div class="col-md-6">
                <h6 class="text-primary mb-3"><i class="fas fa-info-circle me-2"></i>Account Information</h6>
                <table class="table table-sm">
                  <tr><td class="fw-bold">Created:</td><td>${this.formatDateTime(patient.createdAt)}</td></tr>
                  <tr><td class="fw-bold">Created By:</td><td>${patient.createdBy ? 
                    `${patient.createdBy.firstName} ${patient.createdBy.lastName}` : 'System'}</td></tr>
                  <tr><td class="fw-bold">Last Updated:</td><td>${this.formatDateTime(patient.updatedAt)}</td></tr>
                  ${patient.billing?.billingPreferences?.accountBalance ? `
                    <tr><td class="fw-bold">Balance:</td><td>
                      <span class="text-${patient.billing.billingPreferences.accountBalance > 0 ? 'danger' : 'success'}">
                        ${patient.billing.billingPreferences.accountBalance.toFixed(2)}
                      </span>
                    </td></tr>
                  ` : ''}
                </table>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="row mt-4">
              <div class="col-12">
                <h6 class="text-primary mb-3"><i class="fas fa-tasks me-2"></i>Quick Actions</h6>
                <div class="btn-group" role="group">
                  <button type="button" class="btn btn-outline-primary" onclick="PatientManager.viewPatientOrders('${patient._id}')">
                    <i class="fas fa-clipboard-list me-2"></i>View Orders
                  </button>
                  <button type="button" class="btn btn-outline-success" onclick="window.location.href='/orders?newOrder=true&patient=${patient._id}'">
                    <i class="fas fa-plus me-2"></i>New Order
                  </button>
                  <button type="button" class="btn btn-outline-info" onclick="window.location.href='/results?patient=${patient._id}'">
                    <i class="fas fa-vial me-2"></i>View Results
                  </button>
                  <button type="button" class="btn btn-outline-warning" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Print Details
                  </button>
                </div>
              </div>
            </div>
          `;

          document.getElementById('patientDetailsContent').innerHTML = detailsHtml;
          this.detailsModal.show();

        } catch (error) {
          console.error('Error loading patient details:', error);
          this.showAlert('danger', 'Failed to load patient details');
        }
      },

      editPatientFromDetails() {
        this.detailsModal.hide();
        setTimeout(() => {
          this.editPatient(this.currentPatientId);
        }, 300);
      },

      viewPatientOrders(patientId) {
        window.location.href = `/orders?patient=${patientId}`;
      },

      searchPatients() {
        this.currentPage = 1;
        this.loadPatients(1);
      },

      filterPatients() {
        this.currentPage = 1;
        this.loadPatients(1);
      },

      clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('genderFilter').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('limitSelect').value = '10';
        this.loadPatients(1);
      },

      updatePagination(pagination) {
        const paginationEl = document.getElementById('pagination');
        
        if (pagination.pages <= 1) {
          paginationEl.innerHTML = '';
          return;
        }

        let html = '';
        
        // Previous button
        html += `
          <li class="page-item ${pagination.current === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="PatientManager.loadPatients(${pagination.current - 1}); return false;">
              Previous
            </a>
          </li>
        `;

        // Page numbers
        for (let i = 1; i <= pagination.pages; i++) {
          if (i === pagination.current) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
          } else if (i === 1 || i === pagination.pages || 
                     (i >= pagination.current - 2 && i <= pagination.current + 2)) {
            html += `
              <li class="page-item">
                <a class="page-link" href="#" onclick="PatientManager.loadPatients(${i}); return false;">${i}</a>
              </li>
            `;
          } else if (i === pagination.current - 3 || i === pagination.current + 3) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
        }

        // Next button
        html += `
          <li class="page-item ${pagination.current === pagination.pages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="PatientManager.loadPatients(${pagination.current + 1}); return false;">
              Next
            </a>
          </li>
        `;

        paginationEl.innerHTML = html;
      },

      updatePatientCount(total) {
        document.getElementById('patientCount').textContent = total;
      },

      showAlert(type, message) {
        const alertContainer = document.getElementById('alertContainer');
        const alertId = 'alert-' + Date.now();
        
        const alertHtml = `
          <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        `;
        
        alertContainer.innerHTML = alertHtml;
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
          const alertEl = document.getElementById(alertId);
          if (alertEl) {
            const bsAlert = bootstrap.Alert.getOrCreateInstance(alertEl);
            bsAlert.close();
          }
        }, 5000);
      },

      // Utility functions
      formatDate(dateString) {
        return new Date(dateString).toLocaleDateString('en-US');
      },

      formatDateTime(dateString) {
        return new Date(dateString).toLocaleString('en-US');
      },

      calculateAge(birthDate) {
        const today = new Date();
        const birth = new Date(birthDate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
          age--;
        }
        
        return age;
      },

      capitalize(str) {
        if (!str) return 'Unknown';
        return str.charAt(0).toUpperCase() + str.slice(1);
      }
    };

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => PatientManager.init());
    } else {
      PatientManager.init();
    }
  </script>
</body>
</html>
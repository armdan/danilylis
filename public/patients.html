<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patients - Laboratory Information System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/dashboard.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation will be loaded here by navbar-loader.js -->

    <!-- Main Content -->
    <div class="container-fluid main-content">
        <div class="row">
            <div class="col-12">
                <!-- Page Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>
                        <i class="fas fa-users text-primary"></i>
                        Patient Management
                    </h2>
                    <button class="btn btn-primary" onclick="showAddPatientModal()">
                        <i class="fas fa-plus"></i> Add New Patient
                    </button>
                </div>

                <!-- Search and Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="searchInput">Search Patients</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="searchInput" placeholder="Name, ID, Phone, Email...">
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary" type="button" onclick="searchPatients()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="genderFilter">Gender</label>
                                    <select class="form-control" id="genderFilter" onchange="filterPatients()">
                                        <option value="">All</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="statusFilter">Status</label>
                                    <select class="form-control" id="statusFilter" onchange="filterPatients()">
                                        <option value="">All</option>
                                        <option value="true">Active</option>
                                        <option value="false">Inactive</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="limitSelect">Show</label>
                                    <select class="form-control" id="limitSelect" onchange="filterPatients()">
                                        <option value="10">10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <div>
                                        <button class="btn btn-secondary btn-block" onclick="clearFilters()">
                                            <i class="fas fa-times"></i> Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alert Container -->
                <div id="alertContainer"></div>

                <!-- Patients Table -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list"></i> Patient List
                            <span id="patientCount" class="badge badge-primary ml-2">0</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Patient ID</th>
                                        <th>Name</th>
                                        <th>Date of Birth</th>
                                        <th>Gender</th>
                                        <th>Phone</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="patientsTableBody">
                                    <tr id="loadingRow">
                                        <td colspan="8" class="text-center">
                                            <i class="fas fa-spinner fa-spin"></i> Loading patients...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav aria-label="Patient pagination">
                            <ul class="pagination justify-content-center" id="pagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Patient Modal -->
    <div class="modal fade" id="patientModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="patientModalTitle">Add New Patient</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="patientForm">
                        <input type="hidden" id="patientId">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="firstName">First Name *</label>
                                    <input type="text" class="form-control" id="firstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="lastName">Last Name *</label>
                                    <input type="text" class="form-control" id="lastName" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="dateOfBirth">Date of Birth *</label>
                                    <input type="date" class="form-control" id="dateOfBirth" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="gender">Gender *</label>
                                    <select class="form-control" id="gender" required>
                                        <option value="">Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="phone">Phone Number *</label>
                                    <input type="tel" class="form-control" id="phone" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="email">Email</label>
                                    <input type="email" class="form-control" id="email">
                                </div>
                            </div>
                        </div>

                        <h6 class="mt-4 mb-3">Address Information</h6>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="street">Street Address</label>
                                    <input type="text" class="form-control" id="street">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="city">City</label>
                                    <input type="text" class="form-control" id="city">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="state">State</label>
                                    <input type="text" class="form-control" id="state">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="zipCode">ZIP Code</label>
                                    <input type="text" class="form-control" id="zipCode">
                                </div>
                            </div>
                        </div>

                        <h6 class="mt-4 mb-3">Emergency Contact</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="emergencyContactName">Contact Name</label>
                                    <input type="text" class="form-control" id="emergencyContactName">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="emergencyContactPhone">Contact Phone</label>
                                    <input type="tel" class="form-control" id="emergencyContactPhone">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="emergencyContactRelationship">Relationship</label>
                                    <input type="text" class="form-control" id="emergencyContactRelationship" placeholder="e.g., Spouse, Parent, Sibling">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePatient()">
                        <i class="fas fa-save"></i> Save Patient
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Details Modal -->
    <div class="modal fade" id="patientDetailsModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Patient Details</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="patientDetailsContent">
                    <!-- Patient details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="editPatientFromDetails()">
                        <i class="fas fa-edit"></i> Edit Patient
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>
    <script src="js/navbar-loader.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // Initialize patients page
        $(document).ready(function() {
            console.log('🔄 Patients page loading...');
            
            // Load navbar first, then initialize page
            loadNavbar(function() {
                console.log('✅ Navbar loaded, checking auth...');
                
                // Check authentication
                if (!checkAuth()) {
                    console.log('❌ Authentication failed');
                    return;
                }
                
                console.log('✅ Authentication passed');
                
                // Set up event handlers and load data first
                setupEventHandlers();
                
                // Load initial patients data
                console.log('🔄 Loading initial patients...');
                loadPatients(1);
                
                console.log('✅ Patients page initialization complete');

                // Update navbar user name AFTER everything is loaded
                setTimeout(function() {
                    console.log('🔄 Attempting to update navbar user...');
                    if (typeof forceUpdateNavbarUser === 'function') {
                        forceUpdateNavbarUser();
                    } else {
                        // Fallback
                        const user = AuthManager.getUser();
                        const userNameElement = document.getElementById('userName');
                        if (user && userNameElement) {
                            userNameElement.textContent = `${user.firstName} ${user.lastName}`;
                            console.log('✅ Fallback navbar update successful');
                        }
                    }
                }, 500); // Wait 500ms for navbar to fully render
            });
        });

        // Set up event handlers
        function setupEventHandlers() {
            // Enter key search
            $('#searchInput').on('keypress', function(e) {
                if (e.which === 13) {
                    searchPatients();
                }
            });
            
            // Filter change handlers
            $('#genderFilter, #statusFilter, #limitSelect').on('change', function() {
                filterPatients();
            });
            
            console.log('✅ Event handlers set up');
        }
    </script>
</body>
</html>
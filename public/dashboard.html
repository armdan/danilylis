<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Laboratory Information System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/dashboard.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation will be loaded here by navbar-loader.js -->

    <!-- Main Content -->
    <div class="container-fluid main-content">
        <div class="row">
            <!-- Welcome Section -->
            <div class="col-12">
                <div class="welcome-section">
                    <h1 class="welcome-title">Welcome back, <span id="welcomeUserName">User</span>!</h1>
                    <p class="welcome-subtitle">Here's what's happening in your laboratory today</p>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stat-card stat-card-primary">
                    <div class="stat-card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="stat-title">Total Patients</div>
                                <div class="stat-number" id="totalPatients">-</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-users stat-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stat-card stat-card-success">
                    <div class="stat-card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="stat-title">Pending Orders</div>
                                <div class="stat-number" id="pendingOrders">-</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clipboard-list stat-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stat-card stat-card-info">
                    <div class="stat-card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="stat-title">Completed Tests</div>
                                <div class="stat-number" id="completedTests">-</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-vial stat-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stat-card stat-card-warning">
                    <div class="stat-card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="stat-title">Critical Results</div>
                                <div class="stat-number" id="criticalResults">-</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-exclamation-triangle stat-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Recent Activity -->
        <div class="row">
            <!-- Recent Orders -->
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Recent Orders</h5>
                        <a href="/orders" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="recentOrdersTable">
                                <thead>
                                    <tr>
                                        <th>Order #</th>
                                        <th>Patient</th>
                                        <th>Tests</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <i class="fas fa-spinner fa-spin"></i> Loading recent orders...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="col-lg-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="quick-actions">
                            <a href="/patients" class="quick-action-btn" data-role="admin,doctor,receptionist">
                                <i class="fas fa-user-plus"></i>
                                <span>Add Patient</span>
                            </a>
                            <a href="/orders" class="quick-action-btn" data-role="admin,doctor,receptionist">
                                <i class="fas fa-plus-circle"></i>
                                <span>New Order</span>
                            </a>
                            <a href="/results" class="quick-action-btn" data-role="admin,lab_technician">
                                <i class="fas fa-flask"></i>
                                <span>Enter Results</span>
                            </a>
                            <a href="/reports" class="quick-action-btn" data-role="admin,doctor">
                                <i class="fas fa-chart-line"></i>
                                <span>Generate Report</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- System Status -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="system-status">
                            <div class="status-item">
                                <div class="status-indicator status-online"></div>
                                <span>Database Connection</span>
                                <small class="text-success">Online</small>
                            </div>
                            <div class="status-item">
                                <div class="status-indicator status-online"></div>
                                <span>Lab Equipment</span>
                                <small class="text-success">Operational</small>
                            </div>
                            <div class="status-item">
                                <div class="status-indicator status-warning"></div>
                                <span>Backup System</span>
                                <small class="text-warning">Scheduled</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts and Notifications -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Alerts & Notifications</h5>
                    </div>
                    <div class="card-body">
                        <div id="alertsContainer">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                Welcome to the Laboratory Information System! All systems are operational.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>
    <script src="js/navbar-loader.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/dashboard.js"></script>

    <script>
        // Initialize dashboard page
        $(document).ready(function() {
            console.log('🔄 Dashboard loading...');
            
            // Load navbar first, then initialize dashboard
            loadNavbar(function() {
                console.log('✅ Navbar loaded, checking auth...');
                
                // Check authentication
                if (!checkAuth()) {
                    console.log('❌ User not authenticated, redirecting to login...');
                    window.location.href = '/';
                    return;
                }

                console.log('✅ Authentication passed');
                
                // Initialize dashboard first
                try {
                    initializeDashboard();
                    loadDashboardData();
                    setupEventHandlers();
                    console.log('✅ Dashboard initialized successfully');
                } catch (error) {
                    console.error('❌ Error initializing dashboard:', error);
                    showNotification('Error loading dashboard', 'danger');
                }

                // Update navbar user name AFTER everything is loaded
                setTimeout(function() {
                    console.log('🔄 Attempting to update navbar user...');
                    if (typeof forceUpdateNavbarUser === 'function') {
                        forceUpdateNavbarUser();
                    } else {
                        // Fallback
                        const user = AuthManager.getUser();
                        const userNameElement = document.getElementById('userName');
                        if (user && userNameElement) {
                            userNameElement.textContent = `${user.firstName} ${user.lastName}`;
                            console.log('✅ Fallback navbar update successful');
                        }
                    }
                }, 500); // Wait 500ms for navbar to fully render
            });
        });

        // Initialize dashboard with user info
        function initializeDashboard() {
            const user = AuthManager.getUser();
            
            if (user) {
                try {
                    // Update welcome message
                    $('#welcomeUserName').text(user.firstName || 'User');
                    
                    // Show/hide quick actions based on role
                    $('.quick-action-btn').each(function() {
                        const allowedRoles = $(this).data('role');
                        if (allowedRoles) {
                            const roles = allowedRoles.toString().split(',');
                            if (!roles.includes(user.role)) {
                                $(this).hide();
                            }
                        }
                    });
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }
        }

        // Load dashboard data
        function loadDashboardData() {
            loadStatistics();
            loadRecentOrders();
            loadAlerts();
        }

        // Load statistics
        function loadStatistics() {
            fetch('/api/dashboard/statistics', {
                headers: AuthManager.getAuthHeaders()
            })
            .then(response => response.json())
            .then(data => {
                $('#totalPatients').text(data.totalPatients || 0);
                $('#pendingOrders').text(data.pendingOrders || 0);
                $('#completedTests').text(data.completedTests || 0);
                $('#criticalResults').text(data.criticalResults || 0);
            })
            .catch(error => {
                console.error('Error loading statistics:', error);
                // Set default values on error
                $('#totalPatients').text('0');
                $('#pendingOrders').text('0');
                $('#completedTests').text('0');
                $('#criticalResults').text('0');
            });
        }

        // Load recent orders
        function loadRecentOrders() {
            fetch('/api/dashboard/recent-orders', {
                headers: AuthManager.getAuthHeaders()
            })
            .then(response => response.json())
            .then(data => {
                const tbody = $('#recentOrdersTable tbody');
                
                if (data.orders && data.orders.length > 0) {
                    const rows = data.orders.map(order => `
                        <tr>
                            <td><strong>${order.orderNumber}</strong></td>
                            <td>${order.patient ? `${order.patient.firstName} ${order.patient.lastName}` : 'N/A'}</td>
                            <td>${order.tests ? order.tests.length : 0} test(s)</td>
                            <td>
                                <span class="badge badge-${getStatusBadgeClass(order.status)}">
                                    ${capitalizeFirst(order.status)}
                                </span>
                            </td>
                            <td>${formatDate(order.createdAt)}</td>
                        </tr>
                    `).join('');
                    tbody.html(rows);
                } else {
                    tbody.html('<tr><td colspan="5" class="text-center text-muted">No recent orders</td></tr>');
                }
            })
            .catch(error => {
                console.error('Error loading recent orders:', error);
                $('#recentOrdersTable tbody').html('<tr><td colspan="5" class="text-center text-danger">Failed to load orders</td></tr>');
            });
        }

        // Load alerts
        function loadAlerts() {
            fetch('/api/dashboard/alerts', {
                headers: AuthManager.getAuthHeaders()
            })
            .then(response => response.json())
            .then(data => {
                const container = $('#alertsContainer');
                
                if (data.alerts && data.alerts.length > 0) {
                    const alertsHtml = data.alerts.map(alert => `
                        <div class="alert alert-${alert.type}">
                            <i class="fas fa-${getAlertIcon(alert.type)}"></i>
                            ${alert.message}
                        </div>
                    `).join('');
                    container.html(alertsHtml);
                }
            })
            .catch(error => {
                console.error('Error loading alerts:', error);
            });
        }

        // Set up event handlers
        function setupEventHandlers() {
            // Refresh dashboard data every 5 minutes
            setInterval(loadDashboardData, 5 * 60 * 1000);
            
            // Manual refresh button (if exists)
            $('#refreshDashboard').on('click', function() {
                loadDashboardData();
                showNotification('Dashboard refreshed', 'success');
            });
        }

        // Utility functions
        function getStatusBadgeClass(status) {
            const classes = {
                'pending': 'warning',
                'completed': 'success',
                'cancelled': 'danger',
                'processing': 'info'
            };
            return classes[status] || 'secondary';
        }

        function getAlertIcon(type) {
            const icons = {
                'info': 'info-circle',
                'warning': 'exclamation-triangle',
                'danger': 'exclamation-circle',
                'success': 'check-circle'
            };
            return icons[type] || 'info-circle';
        }

        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US');
        }

        function showNotification(message, type) {
            if (typeof showAlert === 'function') {
                showAlert(type, message);
            } else {
                console.log(`${type.toUpperCase()}: ${message}`);
            }
        }
    </script>
</body>
</html>
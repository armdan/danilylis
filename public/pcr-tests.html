<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PCR Tests - Laboratory Information System</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Unified CSS files -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/theme-colors.css">
  <link rel="stylesheet" href="/css/unified-search.css">
  <link rel="stylesheet" href="/css/unified-footer.css">
  
  <style>
    /* Page-specific styles only */
    .test-details { 
      padding: 15px; 
      background: #f8f9fa; 
      border-radius: 5px; 
    }
    .panel-badge { 
      background: #007bff; 
      color: white; 
      padding: 3px 8px; 
      border-radius: 10px; 
      font-size: 0.85em; 
    }
    .target-badge { 
      background: #e7f3ff; 
      padding: 3px 8px; 
      border-radius: 10px; 
      font-size: 0.85em; 
      margin: 2px; 
      display: inline-block;
    }
    .resistance-badge { 
      background: #dc3545; 
      color: white;
      padding: 3px 8px; 
      border-radius: 10px; 
      font-size: 0.85em; 
      margin: 2px; 
      display: inline-block;
    }
    .pathogen-category {
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 5px;
    }
    .category-bacteria { background-color: #28a745; color: white; }
    .category-virus { background-color: #ffc107; color: black; }
    .category-fungus { background-color: #6c757d; color: white; }
    .category-parasite { background-color: #17a2b8; color: white; }
    .table-actions { 
      white-space: nowrap; 
    }
    .table-actions .btn {
      padding: 4px 8px;
      margin: 0 2px;
    }
    .panel-icon {
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <!-- Navbar will be injected here -->

  <div class="container-fluid main-content">
    <!-- Page Header -->
    <div class="page-header">
      <div class="d-flex justify-content-between align-items-center">
        <h1><i class="fas fa-dna me-2"></i>PCR Tests</h1>
        <div class="d-flex gap-3">
          <button class="btn btn-success" onclick="PCRTestManager.initializeTests()" id="initBtn">
            <i class="fas fa-database me-2"></i>Initialize Test Panels
          </button>
          <button class="btn btn-light btn-sm" onclick="exportTests()">
            <i class="fas fa-download me-1"></i>Export
          </button>
        </div>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-value text-primary" id="totalTests">0</div>
          <div class="stat-label">Total Tests</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-value text-success" id="totalPanels">0</div>
          <div class="stat-label">Test Panels</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-value text-info" id="totalTargets">0</div>
          <div class="stat-label">Total Targets</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-value text-warning" id="totalResistance">0</div>
          <div class="stat-label">Resistance Markers</div>
        </div>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="section-header">
      <i class="fas fa-filter"></i> Search & Filters
    </div>
    <div class="card unified-search-card">
      <div class="unified-search-filters">
        <div class="search-group search-main">
          <label for="searchInput">Search Tests</label>
          <div class="search-input-wrapper">
            <input type="text" id="searchInput" class="form-control" 
                   placeholder="Test name, code, or panel...">
            <button class="search-icon" type="button" onclick="searchTests()">
              <i class="fas fa-search"></i>
            </button>
          </div>
        </div>
        <div class="search-group">
          <label for="panelFilter">Test Panel</label>
          <select id="panelFilter" class="form-select">
            <option value="">All Panels</option>
            <option value="UTI">UTI Panel</option>
            <option value="Nail_Fungus">Nail Fungus Panel</option>
            <option value="Pneumonia">Pneumonia Panel</option>
            <option value="Wound">Wound Panel</option>
            <option value="GI">GI Panel</option>
            <option value="COVID_FLU_RSV">COVID/Flu/RSV Panel</option>
            <option value="STI">STI Panel</option>
            <option value="Respiratory">Respiratory Panel</option>
          </select>
        </div>
        <div class="search-group">
          <label for="sampleFilter">Sample Type</label>
          <select id="sampleFilter" class="form-select">
            <option value="">All Sample Types</option>
            <option value="urine">Urine</option>
            <option value="nail_clipping">Nail Clipping</option>
            <option value="sputum">Sputum</option>
            <option value="wound_swab">Wound Swab</option>
            <option value="stool">Stool</option>
            <option value="nasopharyngeal_swab">Nasopharyngeal Swab</option>
          </select>
        </div>
        <div class="search-actions">
          <button class="btn-search-primary" onclick="searchTests()">
            <i class="fas fa-search me-1"></i>Search
          </button>
          <button class="btn-search-secondary" onclick="resetFilters()">
            <i class="fas fa-redo me-1"></i>Reset
          </button>
        </div>
      </div>
    </div>

    <!-- Tests List -->
    <div class="section-header">
      <i class="fas fa-list"></i> Test List
    </div>
    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th width="60">Panel</th>
              <th>Test Name</th>
              <th>Test Code</th>
              <th>Targets</th>
              <th>Resistance Markers</th>
              <th>Sample Type</th>
              <th>Price</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="testsTableBody">
            <!-- Tests will be loaded here -->
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <nav>
        <ul class="pagination justify-content-center" id="pagination">
          <!-- Pagination will be loaded here -->
        </ul>
      </nav>
    </div>
  </div>

  <!-- Test Details Modal -->
  <div class="modal fade" id="testDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Test Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="testDetails">
          <!-- Details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Load auth.js first to set up AuthManager -->
  <script src="/js/auth.js"></script>

  <!-- Auth check and setup -->
  <script>
    // Check authentication using AuthManager
    if (!AuthManager.isAuthenticated()) {
      window.location.href = '/login';
    } else {
      // Set up jQuery AJAX defaults with auth headers
      $.ajaxSetup({
        headers: AuthManager.getAuthHeaders()
      });
    }
  </script>

  <!-- Load navbar after auth is confirmed -->
  <script src="/js/navbar-loader.js"></script>

  <!-- PCR Tests Page Specific Functions -->
  <script>
    // Variables for PCR tests page
    let currentPage = 1;
    const limit = 10;
    let currentTests = [];

    const panelConfigs = {
      'UTI': { icon: 'fa-bacterium', color: 'primary', name: 'Urinary Tract Infection' },
      'Nail_Fungus': { icon: 'fa-disease', color: 'warning', name: 'Nail Fungus' },
      'Pneumonia': { icon: 'fa-lungs', color: 'danger', name: 'Pneumonia' },
      'Wound': { icon: 'fa-band-aid', color: 'info', name: 'Wound Infection' },
      'GI': { icon: 'fa-stomach', color: 'success', name: 'Gastrointestinal' },
      'COVID_FLU_RSV': { icon: 'fa-virus', color: 'dark', name: 'COVID/Flu/RSV' },
      'STI': { icon: 'fa-shield-virus', color: 'secondary', name: 'STI Panel' },
      'Respiratory': { icon: 'fa-head-side-cough', color: 'primary', name: 'Respiratory' }
    };

    $(document).ready(function() {
      loadTests();
      loadStatistics();
      
      // Load footer
      $('#footer-container').load('/components/footer.html', function(response, status, xhr) {
        if (status == "error") {
          console.error("Footer failed to load:", xhr.status, xhr.statusText);
        } else {
          console.log("Footer loaded successfully");
        }
      });
      
      // Enable Enter key search
      $('#searchInput').on('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          searchTests();
        }
      });
    });

    const PCRTestManager = {
      async initializeTests() {
        if (!confirm('This will initialize all PCR test panels. Continue?')) return;

        const btn = document.getElementById('initBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Initializing...';

        try {
          const response = await fetch('/api/pcr/initialize', {
            method: 'POST',
            headers: AuthManager.getAuthHeaders()
          });

          if (!response.ok) throw new Error('Failed to initialize tests');

          const data = await response.json();
          showMessage('PCR tests initialized successfully', 'success');
          loadTests();
          loadStatistics();
        } catch (error) {
          console.error('Error initializing tests:', error);
          showMessage('Failed to initialize tests', 'danger');
        } finally {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-database me-2"></i>Initialize Test Panels';
        }
      },

      async loadTestTargets(panel) {
        if (!panel) return null;

        try {
          const response = await fetch(`/api/pcr/tests/panel/${panel}`, {
            headers: AuthManager.getAuthHeaders()
          });

          if (!response.ok) throw new Error('Failed to load test targets');

          const data = await response.json();
          if (data.tests && data.tests.length > 0) {
            return data.tests[0];
          }
          return null;
        } catch (error) {
          console.error('Error loading test targets:', error);
          return null;
        }
      },

      showPanelDetails(panel) {
        // Filter tests by panel
        $('#panelFilter').val(panel);
        searchTests();
      }
    };

    function resetFilters() {
      $('#searchInput').val('');
      $('#panelFilter').val('');
      $('#sampleFilter').val('');
      loadTests(1);
    }

    function loadStatistics() {
      $.get('/api/pcr/tests?limit=100')
        .done(function(response) {
          const tests = response.tests || [];
          $('#totalTests').text(tests.length);
          
          // Count unique panels
          const panels = [...new Set(tests.map(t => t.panel))];
          $('#totalPanels').text(panels.length);
          
          // Count total targets
          let totalTargets = 0;
          let totalResistance = 0;
          tests.forEach(test => {
            totalTargets += test.targets?.length || 0;
            totalResistance += test.resistanceMarkers?.length || 0;
          });
          $('#totalTargets').text(totalTargets);
          $('#totalResistance').text(totalResistance);
        })
        .fail(function(xhr) {
          console.error('Failed to load statistics:', xhr.status, xhr.responseText);
          $('#totalTests').text('0');
          $('#totalPanels').text('0');
          $('#totalTargets').text('0');
          $('#totalResistance').text('0');
        });
    }

    function loadTests(page = 1) {
      currentPage = page;
      const search = $('#searchInput').val();
      const panel = $('#panelFilter').val();
      const sampleType = $('#sampleFilter').val();
      
      let url = `/api/pcr/tests?page=${page}&limit=${limit}`;
      if (search) url += `&search=${encodeURIComponent(search)}`;
      if (panel) url += `&panel=${panel}`;
      if (sampleType) url += `&sampleType=${sampleType}`;

      $.get(url)
        .done(function(response) {
          currentTests = response.tests || [];
          displayTests(currentTests);
          displayPagination(response.pagination || {});
        })
        .fail(function(xhr) {
          console.error('Failed to load tests');
          $('#testsTableBody').html('<tr><td colspan="8" class="text-center">Failed to load tests</td></tr>');
        });
    }

    function displayTests(tests) {
      const tbody = $('#testsTableBody');
      tbody.empty();

      if (!tests || tests.length === 0) {
        tbody.append(`
          <tr>
            <td colspan="8" class="text-center py-4">
              <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
              <p class="text-muted">No tests found. Click "Initialize Test Panels" to get started.</p>
            </td>
          </tr>
        `);
        return;
      }

      tests.forEach(test => {
        const config = panelConfigs[test.panel] || { icon: 'fa-vial', color: 'secondary' };
        
        const row = `
          <tr>
            <td class="text-center">
              <i class="fas ${config.icon} panel-icon text-${config.color}" title="${test.panel}"></i>
            </td>
            <td>
              <strong>${test.testName}</strong>
            </td>
            <td>
              <code>${test.testCode}</code>
            </td>
            <td>
              <span class="badge bg-primary">${test.targets?.length || 0}</span>
            </td>
            <td>
              ${test.resistanceMarkers?.length > 0 
                ? `<span class="badge bg-danger">${test.resistanceMarkers.length}</span>`
                : '<span class="text-muted">-</span>'}
            </td>
            <td>${test.preferredSampleType || test.sampleTypes?.[0] || 'N/A'}</td>
            <td>$${test.price}</td>
            <td class="table-actions">
              <button class="btn btn-sm btn-info" onclick="viewTest('${test._id}')" title="View Details">
                <i class="fas fa-eye"></i>
              </button>
            </td>
          </tr>
        `;
        tbody.append(row);
      });
    }

    function displayPagination(pagination) {
      const paginationEl = $('#pagination');
      paginationEl.empty();

      if (!pagination || pagination.pages <= 1) return;

      if (pagination.current > 1) {
        paginationEl.append(`
          <li class="page-item">
            <a class="page-link" href="#" onclick="loadTests(${pagination.current - 1}); return false;">Previous</a>
          </li>
        `);
      }

      for (let i = 1; i <= Math.min(pagination.pages, 10); i++) {
        paginationEl.append(`
          <li class="page-item ${pagination.current === i ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadTests(${i}); return false;">${i}</a>
          </li>
        `);
      }

      if (pagination.current < pagination.pages) {
        paginationEl.append(`
          <li class="page-item">
            <a class="page-link" href="#" onclick="loadTests(${pagination.current + 1}); return false;">Next</a>
          </li>
        `);
      }
    }

    function searchTests() {
      loadTests(1);
    }

    function viewTest(testId) {
      $.get(`/api/pcr/tests/${testId}`)
        .done(function(response) {
          const test = response.test;
          const config = panelConfigs[test.panel] || { icon: 'fa-vial', color: 'secondary', name: 'Test Panel' };
          
          let targetsHtml = '';
          if (test.targets && test.targets.length > 0) {
            targetsHtml = '<h6 class="mt-3">Pathogen Targets:</h6><div>';
            test.targets.forEach(target => {
              const categoryClass = `category-${target.category}`;
              targetsHtml += `
                <span class="target-badge">
                  ${target.name}
                  <span class="pathogen-category ${categoryClass}">${target.category}</span>
                </span>
              `;
            });
            targetsHtml += '</div>';
          }

          let resistanceHtml = '';
          if (test.resistanceMarkers && test.resistanceMarkers.length > 0) {
            resistanceHtml = '<h6 class="mt-3">Resistance Markers:</h6><div>';
            test.resistanceMarkers.forEach(marker => {
              resistanceHtml += `
                <span class="resistance-badge">
                  ${marker.marker} (${marker.gene || 'N/A'})
                </span>
              `;
            });
            resistanceHtml += '</div>';
          }

          const details = `
            <div class="test-details">
              <h5><i class="fas ${config.icon} text-${config.color}"></i> ${test.testName}</h5>
              <p class="text-muted">Test Code: ${test.testCode}</p>
              
              <div class="row">
                <div class="col-md-6">
                  <h6>Panel:</h6>
                  <p><span class="panel-badge">${config.name}</span></p>
                  
                  <h6>Price:</h6>
                  <p>$${test.price}</p>
                  
                  <h6>Sample Type:</h6>
                  <p>${test.preferredSampleType || 'Various'}</p>
                </div>
                
                <div class="col-md-6">
                  <h6>CPT Code:</h6>
                  <p>${test.billingCodes?.cptCode || 'N/A'}</p>
                  
                  <h6>LOINC Code:</h6>
                  <p>${test.billingCodes?.loincCode || 'N/A'}</p>
                  
                  <h6>Turnaround Time:</h6>
                  <p>${test.specifications?.turnaroundTime?.value || 24} ${test.specifications?.turnaroundTime?.unit || 'hours'}</p>
                </div>
              </div>
              
              ${targetsHtml}
              ${resistanceHtml}
              
              ${test.description ? `<h6 class="mt-3">Description:</h6><p>${test.description}</p>` : ''}
            </div>
          `;
          
          $('#testDetails').html(details);
          $('#testDetailsModal').modal('show');
        })
        .fail(function(xhr) {
          alert('Failed to load test details');
        });
    }

    function exportTests() {
      const token = AuthManager.getToken();
      if (!token) {
        alert('Authentication required');
        return;
      }

      fetch('/api/pcr/tests?limit=100&format=csv', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Export failed');
        return response.blob();
      })
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pcr_tests_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      })
      .catch(error => {
        console.error('Export error:', error);
        alert('Failed to export tests');
      });
    }

    // Helper function to show success/error messages
    function showMessage(message, type) {
      const alertClass = type === 'success' ? 'alert-success' : 
                        type === 'warning' ? 'alert-warning' : 'alert-danger';
      const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-5" style="z-index: 9999;">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      $('body').append(alertHtml);
      setTimeout(() => {
        $('.alert').fadeOut(() => $('.alert').remove());
      }, 3000);
    }
  </script>

  <!-- Footer container -->
  <div id="footer-container"></div>
</body>
</html>
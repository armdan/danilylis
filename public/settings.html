<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratory Settings - Laboratory Information System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/settings.css" rel="stylesheet">
</head>
<body>
    <!-- Include Navbar -->
    <div id="navbar-container"></div>
    
    <!-- Alert Container -->
    <div id="alertContainer" class="alert-container"></div>

    <!-- Main Content -->
    <div class="container-fluid main-content">
        <!-- Header -->
        <div class="settings-header">
            <h2><i class="fas fa-cog"></i> Laboratory Settings</h2>
            <p class="mb-0">Configure your laboratory information, contact details, and branding</p>
        </div>

        <!-- Settings Form -->
        <form id="settingsForm">
            <!-- Basic Information Card -->
            <div class="card settings-card">
                <div class="card-header">
                    <i class="fas fa-building"></i> Basic Laboratory Information
                </div>
                <div class="card-body">
                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-flask"></i> Laboratory Details
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="required">Laboratory Name</label>
                                    <input type="text" class="form-control" id="labName" name="labName" 
                                           placeholder="Enter laboratory name" maxlength="100" required>
                                    <small class="form-text text-muted">This will appear on all reports and documents</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Tax ID</label>
                                    <input type="text" class="form-control" id="taxId" name="taxId" 
                                           placeholder="Enter tax identification number">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-user-md"></i> Laboratory Director
                        </div>
                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>Title</label>
                                    <select class="form-control" id="directorTitle" name="labDirector.title">
                                        <option value="M.D.">M.D.</option>
                                        <option value="Ph.D.">Ph.D.</option>
                                        <option value="M.D., Ph.D.">M.D., Ph.D.</option>
                                        <option value="D.O.">D.O.</option>
                                        <option value="Dr.">Dr.</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label class="required">First Name</label>
                                    <input type="text" class="form-control" id="directorFirstName" 
                                           name="labDirector.firstName" placeholder="Enter first name" required>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label class="required">Last Name</label>
                                    <input type="text" class="form-control" id="directorLastName" 
                                           name="labDirector.lastName" placeholder="Enter last name" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Information Card -->
            <div class="card settings-card">
                <div class="card-header">
                    <i class="fas fa-address-book"></i> Contact Information
                </div>
                <div class="card-body">
                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-map-marker-alt"></i> Address
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group">
                                    <label class="required">Street Address</label>
                                    <input type="text" class="form-control" id="addressStreet" 
                                           name="address.street" placeholder="Enter street address" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Suite/Unit</label>
                                    <input type="text" class="form-control" id="addressSuite" 
                                           name="address.suite" placeholder="Suite, unit, etc.">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="required">City</label>
                                    <input type="text" class="form-control" id="addressCity" 
                                           name="address.city" placeholder="Enter city" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="required">State</label>
                                    <input type="text" class="form-control" id="addressState" 
                                           name="address.state" placeholder="ST" maxlength="2" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="required">ZIP Code</label>
                                    <input type="text" class="form-control" id="addressZip" 
                                           name="address.zipCode" placeholder="12345" pattern="[0-9]{5}(-[0-9]{4})?" required>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>Country</label>
                                    <input type="text" class="form-control" id="addressCountry" 
                                           name="address.country" value="USA">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-phone"></i> Phone & Communication
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="required">Main Phone</label>
                                    <input type="tel" class="form-control" id="phoneMain" 
                                           name="phone.main" placeholder="(555) 123-4567" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Fax</label>
                                    <input type="tel" class="form-control" id="fax" 
                                           name="fax" placeholder="(555) 123-4568">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Emergency Contact</label>
                                    <input type="tel" class="form-control" id="phoneEmergency" 
                                           name="phone.emergency" placeholder="(555) 911-0000">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>General Email</label>
                                    <input type="email" class="form-control" id="emailGeneral" 
                                           name="email.general" placeholder="info@laboratory.com">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Results Email</label>
                                    <input type="email" class="form-control" id="emailResults" 
                                           name="email.results" placeholder="results@laboratory.com">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Billing Email</label>
                                    <input type="email" class="form-control" id="emailBilling" 
                                           name="email.billing" placeholder="billing@laboratory.com">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Regulatory Information Card -->
            <div class="card settings-card">
                <div class="card-header">
                    <i class="fas fa-certificate"></i> Regulatory Information
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="required">CLIA Number</label>
                                <input type="text" class="form-control" id="cliaNumber" 
                                       name="cliaNumber" placeholder="12D1234567" maxlength="10" required>
                                <small class="form-text text-muted">Clinical Laboratory Improvement Amendments number</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="required">NPI Number</label>
                                <input type="text" class="form-control" id="npiNumber" 
                                       name="npiNumber" placeholder="1234567890" maxlength="10" required>
                                <small class="form-text text-muted">National Provider Identifier</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logo Upload Card -->
            <div class="card settings-card">
                <div class="card-header">
                    <i class="fas fa-image"></i> Laboratory Logo
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="logo-preview" id="logoUploadArea">
                                <div id="noLogoMessage">
                                    <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                                    <p class="mb-0">Click to upload logo</p>
                                    <small class="text-muted">PNG, JPG, SVG up to 5MB</small>
                                </div>
                                <div id="currentLogo" style="display: none;">
                                    <img id="logoImage" src="" alt="Laboratory Logo">
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-danger" id="removeLogo">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <input type="file" id="logoFile" accept="image/*" style="display: none;">
                        </div>
                        <div class="col-md-6">
                            <h6>Logo Guidelines</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> Recommended size: 300x150 pixels</li>
                                <li><i class="fas fa-check text-success"></i> Formats: PNG (preferred), JPG, SVG</li>
                                <li><i class="fas fa-check text-success"></i> Maximum file size: 5MB</li>
                                <li><i class="fas fa-check text-success"></i> Transparent background recommended</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <div class="text-center">
                <button type="submit" class="btn btn-save btn-lg">
                    <i class="fas fa-save"></i> Save Laboratory Settings
                </button>
            </div>
        </form>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js"></script>
    
    <script>
        let currentLogoUrl = null;

        $(document).ready(function() {
            console.log('🚀 Settings page initializing...');
            
            // Load navbar
            loadNavbar();
            
            // Check authorization
            checkAuthorization();
            
            // Load existing settings
            loadSettings();
            
            // Setup event handlers
            setupEventHandlers();
            
            // Load logo if exists
            loadLogo();
        });

        // Load navbar
        function loadNavbar() {
            $('#navbar-container').load('/navbar.html', function(response, status, xhr) {
                if (status === "error") {
                    console.error("Error loading navbar:", xhr.status, xhr.statusText);
                } else {
                    console.log('✅ Navbar loaded successfully');
                }
            });
        }

        // Check if user is authorized (admin only)
        function checkAuthorization() {
            if (typeof AuthManager !== 'undefined') {
                const user = AuthManager.getUser();
                if (!user || user.role !== 'admin') {
                    alert('Access denied. Administrator privileges required for Laboratory Settings.');
                    window.location.href = '/dashboard';
                    return;
                }
                console.log('✅ Admin authorization confirmed');
            } else {
                console.warn('⚠️ AuthManager not available - allowing access for debugging');
            }
        }

        // Load existing settings
        async function loadSettings() {
            try {
                console.log('📥 Loading existing settings...');
                
                if (typeof AuthManager === 'undefined') {
                    console.warn('⚠️ AuthManager not available');
                    return;
                }

                const response = await fetch('/api/settings', {
                    headers: AuthManager.getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    const settings = data.settings;
                    
                    if (settings) {
                        console.log('📋 Populating form with existing settings');
                        populateForm(settings);
                    } else {
                        console.log('📋 No existing settings found - using defaults');
                    }
                } else {
                    console.error('❌ Failed to load settings:', response.status);
                }
            } catch (error) {
                console.error('❌ Error loading settings:', error);
            }
        }

        // Populate form with settings data
        function populateForm(settings) {
            // Basic info
            $('#labName').val(settings.labName || '');
            $('#taxId').val(settings.taxId || '');
            
            // Director info
            if (settings.labDirector) {
                $('#directorTitle').val(settings.labDirector.title || 'M.D.');
                $('#directorFirstName').val(settings.labDirector.firstName || '');
                $('#directorLastName').val(settings.labDirector.lastName || '');
            }
            
            // Address
            if (settings.address) {
                $('#addressStreet').val(settings.address.street || '');
                $('#addressSuite').val(settings.address.suite || '');
                $('#addressCity').val(settings.address.city || '');
                $('#addressState').val(settings.address.state || '');
                $('#addressZip').val(settings.address.zipCode || '');
                $('#addressCountry').val(settings.address.country || 'USA');
            }
            
            // Phone and communication
            if (settings.phone) {
                $('#phoneMain').val(settings.phone.main || '');
                $('#phoneEmergency').val(settings.phone.emergency || '');
            }
            $('#fax').val(settings.fax || '');
            
            // Email
            if (settings.email) {
                $('#emailGeneral').val(settings.email.general || '');
                $('#emailResults').val(settings.email.results || '');
                $('#emailBilling').val(settings.email.billing || '');
            }
            
            // Regulatory
            $('#cliaNumber').val(settings.cliaNumber || '');
            $('#npiNumber').val(settings.npiNumber || '');
            
            console.log('✅ Form populated with settings data');
        }

        // Load logo
        async function loadLogo() {
            try {
                if (typeof AuthManager === 'undefined') return;

                const response = await fetch('/api/settings/logo', {
                    headers: AuthManager.getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.url) {
                        displayLogo(data.url);
                        currentLogoUrl = data.url;
                        console.log('🖼️ Logo loaded successfully');
                    }
                } else if (response.status !== 404) {
                    console.error('❌ Error loading logo:', response.status);
                }
            } catch (error) {
                console.error('❌ Error loading logo:', error);
            }
        }

        // Display logo
        function displayLogo(url) {
            $('#logoImage').attr('src', url);
            $('#noLogoMessage').hide();
            $('#currentLogo').show();
        }

        // Setup event handlers
        function setupEventHandlers() {
            // Form submission
            $('#settingsForm').on('submit', function(e) {
                e.preventDefault();
                saveSettings();
            });

            // Logo upload area click
            $('#logoUploadArea').on('click', function() {
                $('#logoFile').click();
            });

            // File input change
            $('#logoFile').on('change', function(e) {
                if (this.files && this.files[0]) {
                    handleLogoUpload(this.files[0]);
                }
            });

            // Remove logo button
            $('#removeLogo').on('click', function(e) {
                e.stopPropagation();
                if (confirm('Are you sure you want to remove the logo?')) {
                    removeLogo();
                }
            });

            console.log('✅ Event handlers setup complete');
        }

        // Save settings
        async function saveSettings() {
            try {
                console.log('💾 Saving settings...');
                
                if (typeof AuthManager === 'undefined') {
                    showAlert('error', 'Authentication manager not available');
                    return;
                }

                // Collect form data
                const formData = {
                    labName: $('#labName').val().trim(),
                    taxId: $('#taxId').val().trim(),
                    labDirector: {
                        title: $('#directorTitle').val(),
                        firstName: $('#directorFirstName').val().trim(),
                        lastName: $('#directorLastName').val().trim()
                    },
                    address: {
                        street: $('#addressStreet').val().trim(),
                        suite: $('#addressSuite').val().trim(),
                        city: $('#addressCity').val().trim(),
                        state: $('#addressState').val().trim().toUpperCase(),
                        zipCode: $('#addressZip').val().trim(),
                        country: $('#addressCountry').val().trim()
                    },
                    phone: {
                        main: $('#phoneMain').val().trim(),
                        emergency: $('#phoneEmergency').val().trim()
                    },
                    fax: $('#fax').val().trim(),
                    email: {
                        general: $('#emailGeneral').val().trim(),
                        results: $('#emailResults').val().trim(),
                        billing: $('#emailBilling').val().trim()
                    },
                    cliaNumber: $('#cliaNumber').val().trim().toUpperCase(),
                    npiNumber: $('#npiNumber').val().trim()
                };

                console.log('📋 Form data collected:', formData);

                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...AuthManager.getAuthHeaders()
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Settings saved successfully:', result);
                    showAlert('success', 'Laboratory settings saved successfully');
                } else {
                    const error = await response.json();
                    console.error('❌ Save failed:', error);
                    if (error.errors) {
                        const messages = error.errors.map(e => e.msg).join('<br>');
                        showAlert('error', messages);
                    } else {
                        showAlert('error', error.message || 'Failed to save settings');
                    }
                }
            } catch (error) {
                console.error('❌ Save error:', error);
                showAlert('error', 'Failed to save settings');
            }
        }

        // Handle logo upload
        async function handleLogoUpload(file) {
            try {
                console.log('🖼️ Uploading logo:', file.name);

                // Validate file
                if (!file.type.startsWith('image/')) {
                    showAlert('error', 'Please select an image file');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    showAlert('error', 'File size must be less than 5MB');
                    return;
                }

                if (typeof AuthManager === 'undefined') {
                    showAlert('error', 'Authentication manager not available');
                    return;
                }

                const formData = new FormData();
                formData.append('logo', file);

                const response = await fetch('/api/settings/logo', {
                    method: 'POST',
                    headers: AuthManager.getAuthHeaders(),
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Logo uploaded successfully:', result);
                    displayLogo(result.logo.url);
                    currentLogoUrl = result.logo.url;
                    showAlert('success', 'Logo uploaded successfully');
                } else {
                    const error = await response.json();
                    console.error('❌ Logo upload failed:', error);
                    showAlert('error', error.message || 'Failed to upload logo');
                }
            } catch (error) {
                console.error('❌ Logo upload error:', error);
                showAlert('error', 'Failed to upload logo');
            }
        }

        // Remove logo
        async function removeLogo() {
            try {
                console.log('🗑️ Removing logo...');

                if (typeof AuthManager === 'undefined') {
                    showAlert('error', 'Authentication manager not available');
                    return;
                }

                const response = await fetch('/api/settings/logo', {
                    method: 'DELETE',
                    headers: AuthManager.getAuthHeaders()
                });

                if (response.ok) {
                    console.log('✅ Logo removed successfully');
                    $('#currentLogo').hide();
                    $('#noLogoMessage').show();
                    currentLogoUrl = null;
                    showAlert('success', 'Logo removed successfully');
                } else {
                    const error = await response.json();
                    console.error('❌ Logo removal failed:', error);
                    showAlert('error', error.message || 'Failed to remove logo');
                }
            } catch (error) {
                console.error('❌ Logo removal error:', error);
                showAlert('error', 'Failed to remove logo');
            }
        }

        // Show alert
        function showAlert(type, message) {
            const alertClass = type === 'error' ? 'danger' : type;
            const alertContainer = document.getElementById('alertContainer');
            
            const alertHtml = `
                <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>
            `;
            
            alertContainer.innerHTML = alertHtml;
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                $('.alert').alert('close');
            }, 5000);
        }
    </script>
</body>
</html>
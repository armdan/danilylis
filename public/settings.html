<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratory Settings - Laboratory Information System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 70px;
            background-color: #f8f9fa;
        }
        
        .main-content {
            padding: 20px;
        }
        
        .settings-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        .settings-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        .settings-card .card-header {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 1rem 1.5rem;
            font-weight: 600;
        }
        
        .settings-card .card-body {
            padding: 1.5rem;
        }
        
        .logo-preview {
            max-width: 300px;
            max-height: 150px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
        }
        
        .logo-preview img {
            max-width: 100%;
            max-height: 100px;
            object-fit: contain;
        }
        
        .logo-upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: #f0f8ff;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .logo-upload-area:hover {
            background: #e6f3ff;
            border-color: #0056b3;
        }
        
        .logo-upload-area.dragover {
            background: #cce5ff;
            border-color: #004085;
        }
        
        .form-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .form-section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 0.5rem;
            color: #667eea;
        }
        
        .required::after {
            content: ' *';
            color: #dc3545;
        }
        
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 5px 5px 0;
        }
        
        .info-box i {
            color: #007bff;
            margin-right: 0.5rem;
        }
        
        .btn-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            font-weight: 600;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .operating-hours-table {
            margin-top: 1rem;
        }
        
        .operating-hours-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .time-input {
            width: 100px;
        }
        
        .alert-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <!-- Alert Container -->
    <div id="alertContainer" class="alert-container"></div>

    <!-- Main Content -->
    <div class="container-fluid main-content">
        <!-- Header -->
        <div class="settings-header">
            <h2><i class="fas fa-cog"></i> Laboratory Settings</h2>
            <p class="mb-0">Configure your laboratory information, contact details, and branding</p>
        </div>

        <!-- Settings Form -->
        <form id="settingsForm">
            <!-- Basic Information Card -->
            <div class="card settings-card">
                <div class="card-header">
                    <i class="fas fa-building"></i> Basic Laboratory Information
                </div>
                <div class="card-body">
                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-flask"></i> Laboratory Details
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="required">Laboratory Name</label>
                                    <input type="text" class="form-control" id="labName" name="labName" 
                                           placeholder="Enter laboratory name" maxlength="100" required>
                                    <small class="form-text text-muted">This will appear on all reports and documents</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Tax ID</label>
                                    <input type="text" class="form-control" id="taxId" name="taxId" 
                                           placeholder="Enter tax identification number">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-user-md"></i> Laboratory Director
                        </div>
                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>Title</label>
                                    <select class="form-control" id="directorTitle" name="labDirector.title">
                                        <option value="M.D.">M.D.</option>
                                        <option value="Ph.D.">Ph.D.</option>
                                        <option value="M.D., Ph.D.">M.D., Ph.D.</option>
                                        <option value="D.O.">D.O.</option>
                                        <option value="">None</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Country</label>
                                    <input type="text" class="form-control" id="country" name="address.country" 
                                           value="USA" placeholder="USA">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-phone"></i> Phone & Fax
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="required">Main Phone</label>
                                    <input type="tel" class="form-control" id="phoneMain" name="phone.main" 
                                           placeholder="(555) 123-4567" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Toll-Free Phone</label>
                                    <input type="tel" class="form-control" id="phoneTollFree" name="phone.toll_free" 
                                           placeholder="1-800-555-1234">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="required">Fax</label>
                                    <input type="tel" class="form-control" id="fax" name="fax" 
                                           placeholder="(555) 123-4568" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-envelope"></i> Email Addresses
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>General Email</label>
                                    <input type="email" class="form-control" id="emailGeneral" name="email.general" 
                                           placeholder="info@laboratory.com">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Results Email</label>
                                    <input type="email" class="form-control" id="emailResults" name="email.results" 
                                           placeholder="results@laboratory.com">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Billing Email</label>
                                    <input type="email" class="form-control" id="emailBilling" name="email.billing" 
                                           placeholder="billing@laboratory.com">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logo & Branding Card -->
            <div class="card settings-card">
                <div class="card-header">
                    <i class="fas fa-image"></i> Logo & Branding
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="section-title">
                                <i class="fas fa-upload"></i> Laboratory Logo
                            </div>
                            <div class="logo-upload-area" id="logoUploadArea">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3" style="color: #007bff;"></i>
                                <h5>Click to upload or drag and drop</h5>
                                <p class="text-muted mb-0">Supported formats: JPG, PNG, GIF, SVG</p>
                                <p class="text-muted">Maximum file size: 5MB</p>
                                <p class="text-muted">Recommended dimensions: 300x100 pixels</p>
                                <input type="file" id="logoFile" accept="image/*" style="display: none;">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="section-title">
                                <i class="fas fa-eye"></i> Current Logo
                            </div>
                            <div class="logo-preview" id="logoPreview">
                                <div id="noLogoMessage" class="text-muted">
                                    <i class="fas fa-image fa-3x mb-3"></i>
                                    <p>No logo uploaded</p>
                                </div>
                                <div id="currentLogo" style="display: none;">
                                    <img id="logoImage" src="" alt="Laboratory Logo">
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-sm btn-danger" id="removeLogo">
                                            <i class="fas fa-trash"></i> Remove Logo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-right">
                <button type="button" class="btn btn-secondary mr-2" onclick="window.location.href='/dashboard'">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" class="btn btn-save">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </form>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/navbar-loader.js"></script>
    <script>
        let currentLogoUrl = null;

        // Document ready
        $(document).ready(function() {
            // Check authentication
            if (!AuthManager.isAuthenticated()) {
                window.location.href = '/login';
                return;
            }

            // Check if user is admin
            const user = AuthManager.getUser();
            if (user.role !== 'admin') {
                showAlert('error', 'Access denied. Admin privileges required.');
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
                return;
            }

            // Load navbar
            loadNavbar();

            // Load current settings
            loadSettings();

            // Setup event handlers
            setupEventHandlers();
        });

        // Load current settings
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings', {
                    headers: AuthManager.getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.settings) {
                        populateForm(data.settings);
                    }
                }

                // Load logo separately
                loadLogo();
            } catch (error) {
                console.error('Error loading settings:', error);
                showAlert('error', 'Failed to load settings');
            }
        }

        // Populate form with settings data
        function populateForm(settings) {
            // Basic Information
            $('#labName').val(settings.labName || '');
            $('#taxId').val(settings.taxId || '');

            // Director Information
            $('#directorTitle').val(settings.labDirector?.title || 'M.D.');
            $('#directorFirstName').val(settings.labDirector?.firstName || '');
            $('#directorLastName').val(settings.labDirector?.lastName || '');
            $('#directorLicense').val(settings.labDirector?.licenseNumber || '');

            // Regulatory
            $('#cliaNumber').val(settings.cliaNumber || '');
            $('#npiNumber').val(settings.npiNumber || '');

            // Address
            $('#street').val(settings.address?.street || '');
            $('#suite').val(settings.address?.suite || '');
            $('#city').val(settings.address?.city || '');
            $('#state').val(settings.address?.state || '');
            $('#zipCode').val(settings.address?.zipCode || '');
            $('#country').val(settings.address?.country || 'USA');

            // Contact
            $('#phoneMain').val(settings.phone?.main || '');
            $('#phoneTollFree').val(settings.phone?.toll_free || '');
            $('#fax').val(settings.fax || '');
            $('#emailGeneral').val(settings.email?.general || '');
            $('#emailResults').val(settings.email?.results || '');
            $('#emailBilling').val(settings.email?.billing || '');
        }

        // Load logo
        async function loadLogo() {
            try {
                const response = await fetch('/api/settings/logo', {
                    headers: AuthManager.getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.url) {
                        displayLogo(data.url);
                        currentLogoUrl = data.url;
                    }
                }
            } catch (error) {
                console.error('Error loading logo:', error);
            }
        }

        // Display logo
        function displayLogo(url) {
            $('#logoImage').attr('src', url);
            $('#noLogoMessage').hide();
            $('#currentLogo').show();
        }

        // Setup event handlers
        function setupEventHandlers() {
            // Logo upload area click
            $('#logoUploadArea').on('click', function() {
                $('#logoFile').click();
            });

            // Drag and drop
            $('#logoUploadArea').on('dragover', function(e) {
                e.preventDefault();
                $(this).addClass('dragover');
            });

            $('#logoUploadArea').on('dragleave', function(e) {
                e.preventDefault();
                $(this).removeClass('dragover');
            });

            $('#logoUploadArea').on('drop', function(e) {
                e.preventDefault();
                $(this).removeClass('dragover');
                
                const files = e.originalEvent.dataTransfer.files;
                if (files.length > 0) {
                    handleLogoUpload(files[0]);
                }
            });

            // File input change
            $('#logoFile').on('change', function(e) {
                if (this.files && this.files[0]) {
                    handleLogoUpload(this.files[0]);
                }
            });

            // Remove logo button
            $('#removeLogo').on('click', function() {
                if (confirm('Are you sure you want to remove the logo?')) {
                    removeLogo();
                }
            });

            // Form submission
            $('#settingsForm').on('submit', function(e) {
                e.preventDefault();
                saveSettings();
            });

            // Format phone inputs
            $('input[type="tel"]').on('input', function() {
                let value = $(this).val().replace(/\D/g, '');
                if (value.length >= 10) {
                    value = value.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
                    $(this).val(value);
                }
            });

            // Uppercase state code
            $('#state').on('input', function() {
                $(this).val($(this).val().toUpperCase());
            });

            // Uppercase CLIA number
            $('#cliaNumber').on('input', function() {
                $(this).val($(this).val().toUpperCase());
            });
        }

        // Handle logo upload
        async function handleLogoUpload(file) {
            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/svg+xml'];
            if (!allowedTypes.includes(file.type)) {
                showAlert('error', 'Please upload a valid image file (JPG, PNG, GIF, or SVG)');
                return;
            }

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showAlert('error', 'File size must be less than 5MB');
                return;
            }

            const formData = new FormData();
            formData.append('logo', file);

            try {
                const response = await fetch('/api/settings/logo', {
                    method: 'POST',
                    headers: AuthManager.getAuthHeaders(),
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    displayLogo(data.logo.url);
                    currentLogoUrl = data.logo.url;
                    showAlert('success', 'Logo uploaded successfully');
                    
                    // Update navbar logo if it exists
                    updateNavbarLogo(data.logo.url);
                } else {
                    const error = await response.json();
                    showAlert('error', error.message || 'Failed to upload logo');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showAlert('error', 'Failed to upload logo');
            }
        }

        // Remove logo
        async function removeLogo() {
            try {
                const response = await fetch('/api/settings/logo', {
                    method: 'DELETE',
                    headers: AuthManager.getAuthHeaders()
                });

                if (response.ok) {
                    $('#currentLogo').hide();
                    $('#noLogoMessage').show();
                    $('#logoImage').attr('src', '');
                    currentLogoUrl = null;
                    showAlert('success', 'Logo removed successfully');
                    
                    // Reset navbar to default text
                    resetNavbarLogo();
                } else {
                    const error = await response.json();
                    showAlert('error', error.message || 'Failed to remove logo');
                }
            } catch (error) {
                console.error('Remove error:', error);
                showAlert('error', 'Failed to remove logo');
            }
        }

        // Save settings
        async function saveSettings() {
            // Collect form data
            const formData = {
                labName: $('#labName').val(),
                taxId: $('#taxId').val(),
                labDirector: {
                    title: $('#directorTitle').val(),
                    firstName: $('#directorFirstName').val(),
                    lastName: $('#directorLastName').val(),
                    licenseNumber: $('#directorLicense').val()
                },
                address: {
                    street: $('#street').val(),
                    suite: $('#suite').val(),
                    city: $('#city').val(),
                    state: $('#state').val(),
                    zipCode: $('#zipCode').val(),
                    country: $('#country').val() || 'USA'
                },
                cliaNumber: $('#cliaNumber').val(),
                npiNumber: $('#npiNumber').val(),
                phone: {
                    main: $('#phoneMain').val(),
                    toll_free: $('#phoneTollFree').val()
                },
                fax: $('#fax').val(),
                email: {
                    general: $('#emailGeneral').val(),
                    results: $('#emailResults').val(),
                    billing: $('#emailBilling').val()
                }
            };

            try {
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...AuthManager.getAuthHeaders()
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const data = await response.json();
                    showAlert('success', 'Settings saved successfully');
                    
                    // Update navbar with new lab name
                    updateNavbarLabName(formData.labName);
                } else {
                    const error = await response.json();
                    if (error.errors) {
                        const messages = error.errors.map(e => e.msg).join('<br>');
                        showAlert('error', messages);
                    } else {
                        showAlert('error', error.message || 'Failed to save settings');
                    }
                }
            } catch (error) {
                console.error('Save error:', error);
                showAlert('error', 'Failed to save settings');
            }
        }

        // Update navbar with logo
        function updateNavbarLogo(logoUrl) {
            const navbarBrand = $('.navbar-brand');
            if (navbarBrand.length && logoUrl) {
                navbarBrand.html(`<img src="${logoUrl}" alt="Lab Logo" style="height: 40px; max-width: 200px; object-fit: contain;">`);
            }
        }

        // Reset navbar to default
        function resetNavbarLogo() {
            const navbarBrand = $('.navbar-brand');
            if (navbarBrand.length) {
                const labName = $('#labName').val() || 'Laboratory Information System';
                navbarBrand.html(`<i class="fas fa-flask"></i> ${labName}`);
            }
        }

        // Update navbar lab name
        function updateNavbarLabName(labName) {
            const navbarBrand = $('.navbar-brand');
            if (navbarBrand.length && !currentLogoUrl) {
                navbarBrand.html(`<i class="fas fa-flask"></i> ${labName}`);
            }
        }

        // Show alert
        function showAlert(type, message) {
            const alertClass = type === 'error' ? 'danger' : type;
            const alertHtml = `
                <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>
            `;
            
            $('#alertContainer').html(alertHtml);
            
            setTimeout(() => {
                $('.alert').alert('close');
            }, 5000);
        }
    </script>
</body>
</html>
                                    <label class="required">First Name</label>
                                    <input type="text" class="form-control" id="directorFirstName" 
                                           name="labDirector.firstName" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="required">Last Name</label>
                                    <input type="text" class="form-control" id="directorLastName" 
                                           name="labDirector.lastName" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>License Number</label>
                                    <input type="text" class="form-control" id="directorLicense" 
                                           name="labDirector.licenseNumber" placeholder="Professional license #">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-clipboard-check"></i> Regulatory Information
                        </div>
                        <div class="info-box">
                            <i class="fas fa-info-circle"></i>
                            CLIA Number must be exactly 10 characters (letters and numbers only).
                            NPI Number must be exactly 10 digits.
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="required">CLIA Number</label>
                                    <input type="text" class="form-control text-uppercase" id="cliaNumber" 
                                           name="cliaNumber" pattern="[A-Z0-9]{10}" maxlength="10" 
                                           placeholder="Example: 01D0123456" required>
                                    <small class="form-text text-muted">Clinical Laboratory Improvement Amendments certification</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="required">NPI Number</label>
                                    <input type="text" class="form-control" id="npiNumber" name="npiNumber" 
                                           pattern="\d{10}" maxlength="10" placeholder="Example: 1234567890" required>
                                    <small class="form-text text-muted">National Provider Identifier</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Information Card -->
            <div class="card settings-card">
                <div class="card-header">
                    <i class="fas fa-address-card"></i> Contact Information
                </div>
                <div class="card-body">
                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-map-marker-alt"></i> Laboratory Address
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="required">Street Address</label>
                                    <input type="text" class="form-control" id="street" name="address.street" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Suite/Unit</label>
                                    <input type="text" class="form-control" id="suite" name="address.suite" 
                                           placeholder="Optional">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="required">City</label>
                                    <input type="text" class="form-control" id="city" name="address.city" required>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="required">State</label>
                                    <input type="text" class="form-control text-uppercase" id="state" name="address.state" 
                                           maxlength="2" pattern="[A-Z]{2}" placeholder="CA" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="required">ZIP Code</label>
                                    <input type="text" class="form-control" id="zipCode" name="address.zipCode" 
                                           pattern="\d{5}(-\d{4})?" placeholder="12345" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
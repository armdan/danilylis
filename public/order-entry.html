<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Order - Laboratory Information System</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        .main-content {
            padding: 20px;
            min-height: calc(100vh - 64px);
            margin-top: 56px;
        }
        .order-form-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section-title {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        .test-item {
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: move;
        }
        .test-item.selected {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
        }
        .autocomplete-dropdown {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .autocomplete-item:hover {
            background: #f8f9fa;
        }
        .autocomplete-item.selected {
            background: #007bff;
            color: white;
        }
        .create-new-btn {
            padding: 10px;
            background: #28a745;
            color: white;
            cursor: pointer;
            text-align: center;
        }
        .create-new-btn:hover {
            background: #218838;
        }
        .order-summary {
            position: sticky;
            top: 76px;
        }
        .test-category-tabs {
            margin-bottom: 20px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .test-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .test-card:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .test-card.selected {
            background: #d1ecf1;
            border-color: #007bff;
        }
        .priority-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .priority-routine { background: #6c757d; color: white; }
        .priority-urgent { background: #ff9800; color: white; }
        .priority-stat { background: #dc3545; color: white; }
    </style>
</head>
<body>
    <!-- Navbar will be injected here by navbar-loader.js -->

    <div class="container-fluid main-content">
        <div class="row">
            <div class="col-md-8">
                <!-- Order Header -->
                <div class="order-form-section">
                    <h4 class="section-title"><i class="fas fa-file-medical me-2"></i>New Order Entry</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Order Date & Time</label>
                                <input type="datetime-local" class="form-control" id="orderDateTime" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Priority</label>
                                <select class="form-select" id="orderPriority">
                                    <option value="routine">Routine</option>
                                    <option value="urgent">Urgent</option>
                                    <option value="stat">STAT</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Patient Section -->
                <div class="order-form-section">
                    <h5 class="section-title"><i class="fas fa-user me-2"></i>Patient Information</h5>
                    <div class="position-relative">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="patientSearch" 
                                placeholder="Search patient by name, ID, or phone...">
                            <button class="btn btn-outline-primary" type="button" id="searchPatientBtn">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-success" type="button" id="newPatientBtn">
                                <i class="fas fa-plus me-1"></i>New Patient
                            </button>
                        </div>
                        <div id="patientDropdown" class="autocomplete-dropdown" style="display: none;"></div>
                    </div>
                    
                    <div id="selectedPatientInfo" class="alert alert-info" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Selected Patient:</strong>
                                <span id="patientName"></span> | 
                                <span id="patientId"></span> | 
                                <span id="patientDob"></span>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" id="clearPatientBtn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Medical Office & Doctor Section -->
                <div class="order-form-section">
                    <h5 class="section-title"><i class="fas fa-hospital me-2"></i>Medical Office & Doctor</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="position-relative mb-3">
                                <label class="form-label">Medical Office</label>
                                <input type="text" class="form-control" id="officeSearch" 
                                    placeholder="Search or create new office...">
                                <div id="officeDropdown" class="autocomplete-dropdown" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="position-relative mb-3">
                                <label class="form-label">Ordering Doctor</label>
                                <input type="text" class="form-control" id="doctorSearch" 
                                    placeholder="Search or create new doctor...">
                                <div id="doctorDropdown" class="autocomplete-dropdown" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                    <div id="selectedOfficeInfo" class="alert alert-light" style="display: none;"></div>
                    <div id="selectedDoctorInfo" class="alert alert-light" style="display: none;"></div>
                </div>

                <!-- Test Selection Section -->
                <div class="order-form-section">
                    <h5 class="section-title"><i class="fas fa-vial me-2"></i>Test Selection</h5>
                    
                    <!-- Test Categories -->
                    <ul class="nav nav-tabs test-category-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#allTests">All Tests</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#hematology">Hematology</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#chemistry">Chemistry</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#microbiology">Microbiology</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#pcr">PCR</a>
                        </li>
                    </ul>

                    <!-- Test Search -->
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="testSearch" 
                            placeholder="Search tests by name or code...">
                        <button class="btn btn-outline-secondary" type="button" id="clearTestSearch">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Test Grid -->
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="allTests">
                            <div id="testGrid" class="test-grid"></div>
                        </div>
                    </div>
                </div>

                <!-- Clinical Information -->
                <div class="order-form-section">
                    <h5 class="section-title"><i class="fas fa-notes-medical me-2"></i>Clinical Information</h5>
                    <div class="mb-3">
                        <label class="form-label">Clinical Diagnosis (ICD10 Codes)</label>
                        <textarea class="form-control" id="diagnosis" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Special Instructions</label>
                        <textarea class="form-control" id="specialInstructions" rows="2"></textarea>
                    </div>
                </div>
            </div>

            <!-- Order Summary Sidebar -->
            <div class="col-md-4">
                <div class="order-summary order-form-section">
                    <h5 class="section-title"><i class="fas fa-shopping-cart me-2"></i>Order Summary</h5>
                    
                    <div class="mb-3">
                        <strong>Order Number:</strong>
                        <span id="orderNumber" class="text-primary">Will be generated</span>
                    </div>

                    <div id="selectedTests" class="mb-3">
                        <h6>Selected Tests:</h6>
                        <div id="selectedTestsList" class="list-group">
                            <div class="text-muted">No tests selected</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <strong>Total Tests:</strong>
                            <span id="totalTests">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <strong>Total Amount:</strong>
                            <span id="totalAmount">$0.00</span>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg" id="saveOrderBtn" disabled>
                            <i class="fas fa-save me-2"></i>Save Order
                        </button>
                        <button class="btn btn-success" id="saveAndPrintBtn" disabled>
                            <i class="fas fa-print me-2"></i>Save & Print Labels
                        </button>
                        <button class="btn btn-outline-secondary" id="cancelOrderBtn">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Patient Modal -->
    <div class="modal fade" id="newPatientModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Patient</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newPatientForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">First Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="newPatientFirstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Last Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="newPatientLastName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="newPatientDob" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Gender <span class="text-danger">*</span></label>
                                    <select class="form-select" id="newPatientGender" required>
                                        <option value="">Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Phone <span class="text-danger">*</span></label>
                                    <input type="tel" class="form-control" id="newPatientPhone" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="newPatientEmail">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createPatientBtn">Create Patient</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Office Modal -->
    <div class="modal fade" id="newOfficeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Medical Office</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newOfficeForm">
                        <div class="mb-3">
                            <label class="form-label">Office Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="newOfficeName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="newOfficePhone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Address</label>
                            <input type="text" class="form-control" id="newOfficeAddress">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createOfficeBtn">Create Office</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Doctor Modal -->
    <div class="modal fade" id="newDoctorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Doctor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newDoctorForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">First Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="newDoctorFirstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Last Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="newDoctorLastName" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Title</label>
                            <select class="form-select" id="newDoctorTitle">
                                <option value="MD">MD</option>
                                <option value="DO">DO</option>
                                <option value="NP">NP</option>
                                <option value="PA">PA</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">NPI Number</label>
                            <input type="text" class="form-control" id="newDoctorNpi">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="newDoctorPhone">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createDoctorBtn">Create Doctor</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts in correct order -->
    /////
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Load auth.js first to set up AuthManager -->
<script src="/js/auth.js"></script>

<!-- Auth check and setup -->
<script>
  // Check authentication using AuthManager
  if (!AuthManager.isAuthenticated()) {
    window.location.href = '/login';
  } else {
    // Set up jQuery AJAX defaults with auth headers
    $.ajaxSetup({
      headers: AuthManager.getAuthHeaders()
    });
  }
</script>

<!-- Load navbar after auth is confirmed -->
<script src="/js/navbar-loader.js"></script>

//////


    
    <!-- Load the order entry script last -->
    <script src="/js/order-entry.js"></script>
</body>
</html>
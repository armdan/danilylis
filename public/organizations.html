<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Organizations - Laboratory Information System</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body { padding-top: 70px; }
    .main-content { padding: 20px; }
    .card { margin-bottom: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .table-actions { white-space: nowrap; }
    .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.85em; }
    .status-active { background-color: #d4edda; color: #155724; }
    .status-inactive { background-color: #f8d7da; color: #721c24; }
    .status-suspended { background-color: #fff3cd; color: #856404; }
    .search-controls { display: flex; gap: 10px; margin-bottom: 20px; }
    .organization-details { padding: 15px; background: #f8f9fa; border-radius: 5px; }
    .contact-info { margin-top: 10px; }
    .office-count { background: #e7f3ff; padding: 5px 10px; border-radius: 15px; font-size: 0.9em; }
  </style>
  
  <!-- jQuery (load first) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <!-- Navbar will be loaded here -->
  <div id="navbar-placeholder"></div>

  <div class="container-fluid main-content">
    <!-- Page Header -->
    <div class="row mb-4">
      <div class="col-md-12">
        <h2><i class="fas fa-building me-2"></i>Organizations</h2>
        <p class="text-muted">Manage healthcare organizations and their associated medical offices</p>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card bg-primary text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0">Total Organizations</h6>
                <h3 class="mb-0" id="totalOrganizations">0</h3>
              </div>
              <i class="fas fa-building fa-2x opacity-50"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-success text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0">Active</h6>
                <h3 class="mb-0" id="activeOrganizations">0</h3>
              </div>
              <i class="fas fa-check-circle fa-2x opacity-50"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-info text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0">Total Offices</h6>
                <h3 class="mb-0" id="totalOffices">0</h3>
              </div>
              <i class="fas fa-hospital fa-2x opacity-50"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-warning text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0">Total Doctors</h6>
                <h3 class="mb-0" id="totalDoctors">0</h3>
              </div>
              <i class="fas fa-user-md fa-2x opacity-50"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Search and Add Controls -->
    <div class="card">
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <div class="search-controls">
              <input type="text" id="searchInput" class="form-control" placeholder="Search by name, code, or contact...">
              <select id="statusFilter" class="form-select" style="width: 200px;">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="suspended">Suspended</option>
              </select>
              <button class="btn btn-primary" onclick="searchOrganizations()">
                <i class="fas fa-search"></i> Search
              </button>
            </div>
          </div>
          <div class="col-md-4 text-end">
            <button class="btn btn-success" onclick="showAddOrganizationModal()">
              <i class="fas fa-plus"></i> Add Organization
            </button>
            <button class="btn btn-outline-secondary" onclick="exportOrganizations()">
              <i class="fas fa-download"></i> Export
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Organizations List -->
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Code</th>
                <th>Organization Name</th>
                <th>Primary Contact</th>
                <th>Location</th>
                <th>Offices</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="organizationsTableBody">
              <!-- Organizations will be loaded here -->
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <nav>
          <ul class="pagination justify-content-center" id="pagination">
            <!-- Pagination will be loaded here -->
          </ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- Add/Edit Organization Modal -->
  <div class="modal fade" id="organizationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Add Organization</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="organizationForm">
            <input type="hidden" id="organizationId">
            
            <!-- Basic Information -->
            <div class="row mb-3">
              <div class="col-md-8">
                <label class="form-label">Organization Name *</label>
                <input type="text" class="form-control" id="orgName" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Code</label>
                <input type="text" class="form-control" id="orgCode" placeholder="Auto-generated">
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="orgDescription" rows="2"></textarea>
            </div>

            <!-- Address Information -->
            <h6 class="mb-3">Headquarters Address</h6>
            <div class="row mb-3">
              <div class="col-md-8">
                <label class="form-label">Street Address *</label>
                <input type="text" class="form-control" id="orgStreet" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Suite/Unit</label>
                <input type="text" class="form-control" id="orgSuite">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-5">
                <label class="form-label">City *</label>
                <input type="text" class="form-control" id="orgCity" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">State *</label>
                <input type="text" class="form-control" id="orgState" maxlength="2" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">ZIP Code *</label>
                <input type="text" class="form-control" id="orgZipCode" pattern="^\d{5}(-\d{4})?$" required>
              </div>
            </div>

            <!-- Primary Contact -->
            <h6 class="mb-3">Primary Contact</h6>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Contact Name *</label>
                <input type="text" class="form-control" id="contactName" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Title</label>
                <input type="text" class="form-control" id="contactTitle">
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Phone *</label>
                <input type="tel" class="form-control" id="contactPhone" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email *</label>
                <input type="email" class="form-control" id="contactEmail" required>
              </div>
            </div>

            <!-- Business Information -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Tax ID</label>
                <input type="text" class="form-control" id="orgTaxId">
              </div>
              <div class="col-md-6">
                <label class="form-label">Business Type</label>
                <select class="form-select" id="businessType">
                  <option value="medical_group">Medical Group</option>
                  <option value="healthcare_system">Healthcare System</option>
                  <option value="hospital_network">Hospital Network</option>
                  <option value="private_practice">Private Practice</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Notes</label>
              <textarea class="form-control" id="orgNotes" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveOrganization()">Save Organization</button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Organization Details Modal -->
  <div class="modal fade" id="viewOrganizationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Organization Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="organizationDetails">
          <!-- Details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->

<!-- Replace everything from the first <script> tag to </body> with this: -->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Load auth.js first to set up AuthManager -->
<script src="/js/auth.js"></script>

<!-- Auth check and setup -->
<script>
  // Check authentication using AuthManager
  if (!AuthManager.isAuthenticated()) {
    window.location.href = '/login';
  } else {
    // Set up jQuery AJAX defaults with auth headers
    $.ajaxSetup({
      headers: AuthManager.getAuthHeaders()
    });
  }
</script>

<!-- Load navbar after auth is confirmed -->
<script src="/js/navbar-loader.js"></script>

<!-- Organizations Page Specific Functions -->
<script>
  // Variables for organizations page
  let currentPage = 1;
  const limit = 10;

  // Initialize when ready
  $(document).ready(function() {
    loadOrganizations();
    loadStatistics();
  });

// FOR ORGANIZATIONS.HTML - Replace the loadStatistics function with this:

function loadStatistics() {
  $.get('/api/organizations?limit=100')  // Changed from 1000 to 100
    .done(function(response) {
      const orgs = response.organizations || [];
      $('#totalOrganizations').text(orgs.length);
      $('#activeOrganizations').text(orgs.filter(o => o.status === 'active').length);
      
      let totalOfficeCount = 0;
      orgs.forEach(org => {
        totalOfficeCount += org.officeCount || 0;
      });
      $('#totalOffices').text(totalOfficeCount);
      
      // If we got 100 results, there might be more - get the actual total from pagination
      if (response.pagination && response.pagination.total) {
        $('#totalOrganizations').text(response.pagination.total);
      }
    })
    .fail(function(xhr) {
      console.error('Failed to load statistics:', xhr.status, xhr.responseText);
      // Set default values on error
      $('#totalOrganizations').text('0');
      $('#activeOrganizations').text('0');
      $('#totalOffices').text('0');
    });
}

  function loadOrganizations(page = 1) {
    currentPage = page;
    const search = $('#searchInput').val();
    const status = $('#statusFilter').val();
    
    let url = `/api/organizations?page=${page}&limit=${limit}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (status) url += `&status=${status}`;

    $.get(url)
      .done(function(response) {
        displayOrganizations(response.organizations || []);
        displayPagination(response.pagination || {});
      })
      .fail(function(xhr) {
        console.error('Failed to load organizations');
        $('#organizationsTableBody').html('<tr><td colspan="7" class="text-center">Failed to load organizations</td></tr>');
      });
  }

  function displayOrganizations(organizations) {
    const tbody = $('#organizationsTableBody');
    tbody.empty();

    if (!organizations || organizations.length === 0) {
      tbody.append(`
        <tr>
          <td colspan="7" class="text-center py-4">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <p class="text-muted">No organizations found</p>
          </td>
        </tr>
      `);
      return;
    }

    organizations.forEach(org => {
      const statusClass = `status-${org.status}`;
      const row = `
        <tr>
          <td><strong>${org.code || ''}</strong></td>
          <td>
            <div>
              <strong>${org.name || ''}</strong>
              ${org.description ? `<br><small class="text-muted">${org.description}</small>` : ''}
            </div>
          </td>
          <td>
            <div>
              ${org.primaryContact ? org.primaryContact.name : ''}
              ${org.primaryContact && org.primaryContact.title ? `<br><small class="text-muted">${org.primaryContact.title}</small>` : ''}
              ${org.primaryContact && org.primaryContact.phone ? `<br><small><i class="fas fa-phone"></i> ${org.primaryContact.phone}</small>` : ''}
              ${org.primaryContact && org.primaryContact.email ? `<br><small><i class="fas fa-envelope"></i> ${org.primaryContact.email}</small>` : ''}
            </div>
          </td>
          <td>
            <small>
              ${org.headquarters ? `
                ${org.headquarters.street || ''}${org.headquarters.suite ? ', ' + org.headquarters.suite : ''}<br>
                ${org.headquarters.city || ''}, ${org.headquarters.state || ''} ${org.headquarters.zipCode || ''}
              ` : ''}
            </small>
          </td>
          <td>
            <span class="office-count">
              <i class="fas fa-hospital"></i> ${org.officeCount || 0} offices
            </span>
          </td>
          <td>
            <span class="status-badge ${statusClass}">
              ${org.status ? org.status.charAt(0).toUpperCase() + org.status.slice(1) : ''}
            </span>
          </td>
          <td class="table-actions">
            <button class="btn btn-sm btn-info" onclick="viewOrganization('${org._id}')" title="View">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-warning" onclick="editOrganization('${org._id}')" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteOrganization('${org._id}')" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `;
      tbody.append(row);
    });
  }

  function displayPagination(pagination) {
    const paginationEl = $('#pagination');
    paginationEl.empty();

    if (!pagination || pagination.pages <= 1) return;

    if (pagination.current > 1) {
      paginationEl.append(`
        <li class="page-item">
          <a class="page-link" href="#" onclick="loadOrganizations(${pagination.current - 1}); return false;">Previous</a>
        </li>
      `);
    }

    for (let i = 1; i <= Math.min(pagination.pages, 10); i++) {
      paginationEl.append(`
        <li class="page-item ${pagination.current === i ? 'active' : ''}">
          <a class="page-link" href="#" onclick="loadOrganizations(${i}); return false;">${i}</a>
        </li>
      `);
    }

    if (pagination.current < pagination.pages) {
      paginationEl.append(`
        <li class="page-item">
          <a class="page-link" href="#" onclick="loadOrganizations(${pagination.current + 1}); return false;">Next</a>
        </li>
      `);
    }
  }

  function searchOrganizations() {
    loadOrganizations(1);
  }

  function showAddOrganizationModal() {
    $('#modalTitle').text('Add Organization');
    $('#organizationForm')[0].reset();
    $('#organizationId').val('');
    $('#organizationModal').modal('show');
  }

  function editOrganization(id) {
    $.get(`/api/organizations/${id}`)
      .done(function(response) {
        const org = response.organization;
        $('#modalTitle').text('Edit Organization');
        $('#organizationId').val(org._id);
        $('#orgName').val(org.name);
        $('#orgCode').val(org.code);
        $('#orgDescription').val(org.description || '');
        $('#orgStreet').val(org.headquarters ? org.headquarters.street : '');
        $('#orgSuite').val(org.headquarters ? org.headquarters.suite : '');
        $('#orgCity').val(org.headquarters ? org.headquarters.city : '');
        $('#orgState').val(org.headquarters ? org.headquarters.state : '');
        $('#orgZipCode').val(org.headquarters ? org.headquarters.zipCode : '');
        $('#contactName').val(org.primaryContact ? org.primaryContact.name : '');
        $('#contactTitle').val(org.primaryContact ? org.primaryContact.title : '');
        $('#contactPhone').val(org.primaryContact ? org.primaryContact.phone : '');
        $('#contactEmail').val(org.primaryContact ? org.primaryContact.email : '');
        $('#orgTaxId').val(org.taxId || '');
        $('#businessType').val(org.businessType || 'medical_group');
        $('#orgNotes').val(org.notes || '');
        $('#organizationModal').modal('show');
      })
      .fail(function(xhr) {
        alert('Failed to load organization details');
      });
  }

// Replace the saveOrganization function in organizations.html with this debug version:

// Replace the saveOrganization function in organizations.html with this version:

// Replace the data building section in saveOrganization function with this:

function saveOrganization() {
  // ... (keep all the validation code from before) ...

  const id = $('#organizationId').val();
  
  // Generate a code if not provided
  let orgCode = $('#orgCode').val().trim();
  if (!orgCode) {
    // Generate code from organization name (e.g., "Memorial Hospital" -> "MH-001")
    const nameParts = $('#orgName').val().trim().split(' ');
    const initials = nameParts.map(word => word.charAt(0).toUpperCase()).join('');
    const timestamp = Date.now().toString().slice(-3); // Last 3 digits of timestamp
    orgCode = `${initials}-${timestamp}`;
  }
  
  // Build the data object with validated values
  const data = {
    name: $('#orgName').val().trim(),
    code: orgCode,  // Now always has a value
    description: $('#orgDescription').val().trim(),
    headquarters: {
      street: $('#orgStreet').val().trim(),
      suite: $('#orgSuite').val().trim(),
      city: $('#orgCity').val().trim(),
      state: $('#orgState').val().trim().toUpperCase(),
      zipCode: $('#orgZipCode').val().trim()
    },
    primaryContact: {
      name: $('#contactName').val().trim(),
      title: $('#contactTitle').val().trim(),
      phone: $('#contactPhone').val().trim(),
      email: $('#contactEmail').val().trim()
    },
    businessType: $('#businessType').val() || 'medical_group',
    status: 'active'
  };

  // Add optional fields only if they have values
  const taxId = $('#orgTaxId').val().trim();
  if (taxId) data.taxId = taxId;

  const notes = $('#orgNotes').val().trim();
  if (notes) data.notes = notes;

  // Remove empty optional nested fields
  if (!data.headquarters.suite) delete data.headquarters.suite;
  if (!data.primaryContact.title) delete data.primaryContact.title;
  if (!data.description) delete data.description;

  console.log('Saving organization with validated data:', JSON.stringify(data, null, 2));

  const url = id ? `/api/organizations/${id}` : '/api/organizations';
  const method = id ? 'PUT' : 'POST';

  $.ajax({
    url: url,
    method: method,
    contentType: 'application/json',
    data: JSON.stringify(data),
    success: function(response) {
      console.log('Save successful:', response);
      $('#organizationModal').modal('hide');
      loadOrganizations(currentPage);
      loadStatistics();
      alert('Organization saved successfully');
    },
    error: function(xhr) {
      console.error('Save failed:', xhr.status, xhr.responseText);
      
      let errorMessage = 'Failed to save organization';
      
      if (xhr.responseJSON) {
        if (xhr.responseJSON.message) {
          errorMessage = xhr.responseJSON.message;
        } else if (xhr.responseJSON.errors && Array.isArray(xhr.responseJSON.errors)) {
          const errors = xhr.responseJSON.errors.map(err => 
            `${err.param || err.field || 'Field'}: ${err.msg || err.message}`
          );
          errorMessage = 'Validation errors:\n' + errors.join('\n');
        }
      }
      
      // If it's a duplicate code error, generate a new one
      if (errorMessage.includes('duplicate') && errorMessage.includes('code')) {
        alert('Organization code already exists. Please enter a unique code or leave blank for auto-generation.');
        $('#orgCode').focus();
        return;
      }
      
      alert('Error: ' + errorMessage);
    }
  });
}

  function viewOrganization(id) {
    $.get(`/api/organizations/${id}`)
      .done(function(response) {
        const org = response.organization;
        const offices = response.medicalOffices || [];
        
        let officesList = '';
        if (offices.length > 0) {
          officesList = '<h6 class="mt-3">Associated Medical Offices:</h6><ul>';
          offices.forEach(office => {
            officesList += `<li>${office.name} (${office.officeCode}) - ${office.status}</li>`;
          });
          officesList += '</ul>';
        }

        const details = `
          <div class="organization-details">
            <h5>${org.name}</h5>
            <p class="text-muted">${org.description || 'No description'}</p>
            
            <div class="row">
              <div class="col-md-6">
                <h6>Organization Code:</h6>
                <p>${org.code}</p>
                
                <h6>Business Type:</h6>
                <p>${org.businessType ? org.businessType.replace('_', ' ').toUpperCase() : ''}</p>
                
                <h6>Status:</h6>
                <p><span class="status-badge status-${org.status}">${org.status ? org.status.toUpperCase() : ''}</span></p>
              </div>
              
              <div class="col-md-6">
                <h6>Headquarters:</h6>
                <p>
                  ${org.headquarters ? `
                    ${org.headquarters.street}${org.headquarters.suite ? ', ' + org.headquarters.suite : ''}<br>
                    ${org.headquarters.city}, ${org.headquarters.state} ${org.headquarters.zipCode}
                  ` : 'Not provided'}
                </p>
                
                <h6>Primary Contact:</h6>
                <p>
                  ${org.primaryContact ? `
                    ${org.primaryContact.name}${org.primaryContact.title ? ' - ' + org.primaryContact.title : ''}<br>
                    <i class="fas fa-phone"></i> ${org.primaryContact.phone}<br>
                    <i class="fas fa-envelope"></i> ${org.primaryContact.email}
                  ` : 'Not provided'}
                </p>
              </div>
            </div>
            
            ${officesList}
            
            ${org.notes ? `<h6 class="mt-3">Notes:</h6><p>${org.notes}</p>` : ''}
          </div>
        `;
        
        $('#organizationDetails').html(details);
        $('#viewOrganizationModal').modal('show');
      })
      .fail(function(xhr) {
        alert('Failed to load organization details');
      });
  }

  function deleteOrganization(id) {
    if (confirm('Are you sure you want to deactivate this organization?')) {
      $.ajax({
        url: `/api/organizations/${id}`,
        method: 'DELETE',
        success: function(response) {
          loadOrganizations(currentPage);
          loadStatistics();
          alert('Organization deactivated successfully');
        },
        error: function(xhr) {
          const error = xhr.responseJSON?.message || 'Failed to delete organization';
          alert('Error: ' + error);
        }
      });
    }
  }
function exportOrganizations() {
  window.open('/api/organizations?limit=100&format=csv', '_blank');  // Changed from 1000
}
</script>
</body>
</html>
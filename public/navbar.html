<!-- Shared Navigation Component -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard">
            <i class="fas fa-flask"></i>
            Laboratory Information System
        </a>
        
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item" data-page="dashboard">
                    <a class="nav-link" href="/dashboard">
                        <i class="fas fa-chart-pie"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item" data-page="patients">
                    <a class="nav-link" href="/patients">
                        <i class="fas fa-users"></i> Patients
                    </a>
                </li>
                <li class="nav-item" data-page="tests">
                    <a class="nav-link" href="/tests">
                        <i class="fas fa-vial"></i> Tests
                    </a>
                </li>
                <li class="nav-item" data-page="orders">
                    <a class="nav-link" href="/orders">
                        <i class="fas fa-clipboard-list"></i> Orders
                    </a>
                </li>
                <li class="nav-item" data-page="results">
                    <a class="nav-link" href="/results">
                        <i class="fas fa-chart-line"></i> Results
                    </a>
                </li>
                <li class="nav-item" data-page="reports">
                    <a class="nav-link" href="/reports">
                        <i class="fas fa-file-medical"></i> Reports
                    </a>
                </li>
            </ul>
            
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown">
                        <i class="fas fa-user-circle"></i>
                        <span id="userName">User</span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right">
                        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#profileModal">
                            <i class="fas fa-user"></i> Profile
                        </a>
                        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#settingsModal">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Profile</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="profileFirstName">First Name</label>
                                <input type="text" class="form-control" id="profileFirstName">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="profileLastName">Last Name</label>
                                <input type="text" class="form-control" id="profileLastName">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="profileEmail">Email</label>
                        <input type="email" class="form-control" id="profileEmail">
                    </div>
                    <div class="form-group">
                        <label for="profilePhone">Phone</label>
                        <input type="tel" class="form-control" id="profilePhone">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="profileRole">Role</label>
                                <input type="text" class="form-control" id="profileRole" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="profileDepartment">Department</label>
                                <input type="text" class="form-control" id="profileDepartment" readonly>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="updateProfile()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Application Settings</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- User Preferences -->
                    <div class="col-md-6">
                        <h6><i class="fas fa-user-cog"></i> User Preferences</h6>
                        <div class="form-group">
                            <label for="themeSelect">Theme</label>
                            <select class="form-control" id="themeSelect">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                            </select>
                            <small class="form-text text-muted">Choose your preferred interface theme</small>
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notificationsEnabled">
                                <label class="form-check-label" for="notificationsEnabled">
                                    Enable notifications
                                </label>
                            </div>
                            <small class="form-text text-muted">Receive alerts for critical results and system updates</small>
                        </div>
                    </div>
                    
                    <!-- Laboratory Settings Preview -->
                    <div class="col-md-6">
                        <h6><i class="fas fa-building"></i> Laboratory Settings</h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Coming Soon!</strong><br>
                            Laboratory configuration settings will include:
                            <ul class="mb-0 mt-2">
                                <li>Laboratory Name & Logo</li>
                                <li>Lab Director Information</li>
                                <li>CLIA & NPI Numbers</li>
                                <li>Contact Information</li>
                            </ul>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" disabled>
                            <i class="fas fa-cog"></i> Configure Laboratory
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Navigation JavaScript
$(document).ready(function() {
    // Set active navigation item based on current page
    setActiveNavItem();
    
    // Update user name in navigation
    updateNavbarUser();
    
    // Initialize profile modal when shown - EXPLICIT BINDING
    $('#profileModal').off('show.bs.modal').on('show.bs.modal', function() {
        console.log('ðŸ”„ Profile modal opening - initializing data...');
        initializeProfileModal();
    });
    
    // Initialize settings modal when shown - EXPLICIT BINDING  
    $('#settingsModal').off('show.bs.modal').on('show.bs.modal', function() {
        console.log('ðŸ”„ Settings modal opening - initializing data...');
        initializeSettingsModal();
    });
    
    // Also try to initialize immediately when navbar loads
    setTimeout(() => {
        if (typeof AuthManager !== 'undefined') {
            console.log('ðŸ”„ Setting up modal initializers...');
            // Force rebind the events
            $('#profileModal').off('show.bs.modal').on('show.bs.modal', function() {
                console.log('ðŸ”„ Profile modal event triggered');
                initializeProfileModal();
            });
        }
    }, 200);
});

// Set active navigation item based on current page
function setActiveNavItem() {
    const currentPath = window.location.pathname;
    let activePage = 'dashboard'; // default
    
    if (currentPath.includes('/patients')) activePage = 'patients';
    else if (currentPath.includes('/tests')) activePage = 'tests';
    else if (currentPath.includes('/orders')) activePage = 'orders';
    else if (currentPath.includes('/results')) activePage = 'results';
    else if (currentPath.includes('/reports')) activePage = 'reports';
    
    // Remove active class from all nav items
    $('.nav-item').removeClass('active');
    
    // Add active class to current page nav item
    $(`.nav-item[data-page="${activePage}"]`).addClass('active');
}

// Update user name in navigation
function updateNavbarUser() {
    if (typeof AuthManager !== 'undefined') {
        const user = AuthManager.getUser();
        if (user && user.firstName && user.lastName) {
            const userNameElement = document.getElementById('userName');
            if (userNameElement) {
                userNameElement.textContent = `${user.firstName} ${user.lastName}`;
                console.log('âœ… Updated navbar user name:', `${user.firstName} ${user.lastName}`);
            }
        } else {
            console.log('âš ï¸ User data not available for navbar update');
        }
    } else {
        console.log('âš ï¸ AuthManager not available for navbar update');
    }
}

// Initialize profile modal with user data
function initializeProfileModal() {
    if (typeof AuthManager !== 'undefined') {
        const user = AuthManager.getUser();
        if (user) {
            document.getElementById('profileFirstName').value = user.firstName || '';
            document.getElementById('profileLastName').value = user.lastName || '';
            document.getElementById('profileEmail').value = user.email || '';
            document.getElementById('profilePhone').value = user.phone || '';
            document.getElementById('profileRole').value = (user.role || '').replace('_', ' ').toUpperCase();
            document.getElementById('profileDepartment').value = (user.department || '').toUpperCase();
            
            console.log('âœ… Profile modal initialized with user data');
        } else {
            console.log('âš ï¸ No user data available for profile modal');
        }
    }
}

// Initialize settings modal
function initializeSettingsModal() {
    // Load saved settings from localStorage
    const theme = localStorage.getItem('app_theme') || 'light';
    const notifications = localStorage.getItem('app_notifications') !== 'false';
    
    document.getElementById('themeSelect').value = theme;
    document.getElementById('notificationsEnabled').checked = notifications;
    
    console.log('âœ… Settings modal initialized');
}

// Update profile function
function updateProfile() {
    const profileData = {
        firstName: document.getElementById('profileFirstName').value,
        lastName: document.getElementById('profileLastName').value,
        email: document.getElementById('profileEmail').value,
        phone: document.getElementById('profilePhone').value
    };

    if (typeof AuthManager !== 'undefined') {
        fetch('/api/auth/profile', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                ...AuthManager.getAuthHeaders()
            },
            body: JSON.stringify(profileData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                // Update stored user data
                localStorage.setItem('user', JSON.stringify(data.user));
                
                // Update navbar
                updateNavbarUser();
                
                $('#profileModal').modal('hide');
                
                // Show success message
                if (typeof showAlert === 'function') {
                    showAlert('success', 'Profile updated successfully');
                } else {
                    alert('Profile updated successfully');
                }
            }
        })
        .catch(error => {
            console.error('Error updating profile:', error);
            if (typeof showAlert === 'function') {
                showAlert('error', 'Failed to update profile');
            } else {
                alert('Failed to update profile');
            }
        });
    }
}

// Save settings function
function saveSettings() {
    const theme = document.getElementById('themeSelect').value;
    const notifications = document.getElementById('notificationsEnabled').checked;
    
    // Save to localStorage
    localStorage.setItem('app_theme', theme);
    localStorage.setItem('app_notifications', notifications);
    
    // Apply theme immediately
    applyTheme(theme);
    
    $('#settingsModal').modal('hide');
    
    if (typeof showAlert === 'function') {
        showAlert('success', 'Settings saved successfully');
    } else {
        alert('Settings saved successfully');
    }
    
    console.log('âœ… Settings saved:', { theme, notifications });
}

// Apply theme function
function applyTheme(theme) {
    if (theme === 'dark') {
        document.body.classList.add('dark-theme');
    } else {
        document.body.classList.remove('dark-theme');
    }
}

// Apply saved theme on page load
$(document).ready(function() {
    const savedTheme = localStorage.getItem('app_theme') || 'light';
    applyTheme(savedTheme);
    
    // Auto-update navbar user when navbar loads
    setTimeout(function() {
        if (typeof AuthManager !== 'undefined') {
            const user = AuthManager.getUser();
            if (user && user.firstName && user.lastName) {
                const userNameElement = document.getElementById('userName');
                if (userNameElement) {
                    userNameElement.textContent = `${user.firstName} ${user.lastName}`;
                    console.log('ðŸŽ¯ Navbar auto-updated user:', `${user.firstName} ${user.lastName}`);
                }
            }
        }
    }, 100);
});
</script>